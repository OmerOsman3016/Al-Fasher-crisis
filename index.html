<!DOCTYPE html>
<html lang="en" data-app="fmc-dashboard">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Flow Monitoring Dashboard — Border Points</title>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <!-- Chart.js (charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Brand palette (IOM-inspired) */
      --brand-primary:#0033A0; /* deep blue */
      --brand-accent:#418FDE;  /* accent blue */
      --brand-amber:#FFB81C;
      --brand-orange:#FF671F;
      --brand-red:#D22630;

      --ok:#2BB673;     /* incoming */
      --warn:#FF8C42;   /* outgoing */
      --both:#7A5CFA;   /* combined */

      --surface:#f5f7fa;
      --panel:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --chip:#eef2ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Open Sans", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--ink);
      background:var(--surface);
    }

    header{
      background:linear-gradient(90deg, var(--brand-primary), var(--brand-accent));
      color:#fff;
      padding:16px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
      position:sticky; top:0; z-index:10;
    }
    header .title{
      font-weight:800; letter-spacing:.2px; font-size:20px;
    }
    header .subtitle{opacity:.9; font-weight:600; font-size:12px}

    .container{
      padding:16px;
      max-width:1400px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }

    /* Controls row */
    .controls{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 1100px){ .controls{ grid-template-columns:1fr 1fr } }
    @media (max-width: 640px){ .controls{ grid-template-columns:1fr } }

    .control{
      display:flex; gap:8px; align-items:center; background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px;
    }
    .control label{ font-size:12px; color:var(--muted); min-width:88px }
    .control select, .control input[type="range"]{
      width:100%; border:none; outline:none; background:transparent; font:inherit; color:var(--ink);
    }
    .chip{
      padding:6px 10px; border-radius:999px; background:var(--chip); font-size:12px; font-weight:600; color:#4537ff;
    }

    /* KPIs */
    .kpis{
      display:grid; grid-template-columns:repeat(4,1fr); gap:12px;
    }
    @media (max-width: 900px){ .kpis{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width: 520px){ .kpis{ grid-template-columns:1fr } }

    .kpi{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
    }
    .kpi .label{ font-size:12px; color:var(--muted) }
    .kpi .value{ font-size:22px; font-weight:800; margin-top:4px }
    .kpi .delta{ font-size:12px; margin-top:6px }
    .kpi.ok .value{ color:var(--ok) }
    .kpi.warn .value{ color:var(--warn) }
    .kpi.both .value{ color:var(--both) }

    /* Main grid */
    .main{
      display:grid; grid-template-columns: 1.4fr 1fr; gap:16px;
    }
    @media (max-width: 1100px){ .main{ grid-template-columns:1fr } }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height:360px;
    }
    .panel header{
      background:#fff;
      border-bottom:1px solid var(--border);
      color:var(--ink);
      padding:12px 14px;
      position:unset;
    }
    .panel header .title{ font-size:14px; font-weight:800 }
    .panel header .subtitle{ font-size:12px; color:var(--muted); font-weight:600 }

    #map{ height:520px; }
    .legend{
      position:absolute; bottom:12px; left:12px; background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:12px; box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .legend .row{ display:flex; align-items:center; gap:8px; margin:4px 0 }
    .dot{ width:12px; height:12px; border-radius:999px; display:inline-block }

    /* Table */
    .table-wrap{ overflow:auto; }
    table{
      width:100%; border-collapse:separate; border-spacing:0; font-size:13px;
    }
    thead th{
      position:sticky; top:0; background:#fff; z-index:1;
      text-align:left; padding:10px; border-bottom:1px solid var(--border); white-space:nowrap; font-weight:800; color:var(--muted);
    }
    tbody td{ padding:8px 10px; border-bottom:1px solid var(--border); white-space:nowrap; }
    tbody tr:hover{ background:#fafbff; }

    .footer-note{
      color:var(--muted); font-size:12px; text-align:center; padding:16px 0;
    }

    /* Buttons / toggles */
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid var(--border); background:#fff;
      font-weight:700; font-size:12px; cursor:pointer;
    }
    .btn:active{ transform:translateY(1px) }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Sudan — Flow Monitoring Dashboard (Border Points)</div>
      <div class="subtitle">Interactive map, KPIs, time-series & table • Months: Jan 2024 → Aug 2025</div>
    </div>
    <div class="chip" id="chipSelection">All Points • Both Directions • 2025-Aug</div>
  </header>

  <div class="container">
    <!-- Controls -->
    <section class="controls">
      <div class="control">
        <label for="direction">Direction</label>
        <select id="direction">
          <option value="Both" selected>Both</option>
          <option value="Incoming">Incoming</option>
          <option value="Outgoing">Outgoing</option>
        </select>
      </div>

      <div class="control">
        <label for="point">Border Point</label>
        <select id="point">
          <option value="__ALL__" selected>All points</option>
        </select>
      </div>

      <div class="control">
        <label for="month">Month</label>
        <input id="month" type="range" min="0" max="19" step="1" value="19" />
      </div>

      <div class="control">
        <label for="search">Search</label>
        <input id="search" placeholder="Type to filter table…" />
      </div>
    </section>

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi ok">
        <div class="label">Incoming (selected)</div>
        <div class="value" id="kpiIncoming">0</div>
        <div class="delta" id="kpiIncomingDelta">vs prev. month: —</div>
      </div>
      <div class="kpi warn">
        <div class="label">Outgoing (selected)</div>
        <div class="value" id="kpiOutgoing">0</div>
        <div class="delta" id="kpiOutgoingDelta">vs prev. month: —</div>
      </div>
      <div class="kpi both">
        <div class="label">Total flow (selected)</div>
        <div class="value" id="kpiTotal">0</div>
        <div class="delta" id="kpiTotalDelta">vs prev. month: —</div>
      </div>
      <div class="kpi">
        <div class="label">Net flow (Incoming − Outgoing)</div>
        <div class="value" id="kpiNet">0</div>
        <div class="delta" id="kpiNetDelta">vs prev. month: —</div>
      </div>
    </section>

    <!-- Main panels -->
    <section class="main">
      <div class="panel">
        <header><div class="title">Map — Circle size by selected month & direction</div><div class="subtitle">Click a marker for details</div></header>
        <div style="position:relative; flex:1">
          <div id="map"></div>
          <div class="legend">
            <div class="row"><span class="dot" style="background:var(--ok)"></span> Incoming</div>
            <div class="row"><span class="dot" style="background:var(--warn)"></span> Outgoing</div>
            <div class="row"><span class="dot" style="background:var(--both)"></span> Both</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <header><div class="title">Time Series — Aggregated by month</div><div class="subtitle" id="tsSubtitle">All points • Both directions</div></header>
        <div style="padding:10px">
          <canvas id="tsChart" height="300"></canvas>
        </div>
      </div>
    </section>

    <section class="panel">
      <header style="display:flex; align-items:center; justify-content:space-between">
        <div>
          <div class="title">By Point — Selected Month</div>
          <div class="subtitle" id="barSubtitle">2025-Aug • Both directions</div>
        </div>
        <button class="btn" id="downloadCsvBtn">Download CSV</button>
      </header>
      <div style="padding:10px">
        <canvas id="barChart" height="240"></canvas>
      </div>
    </section>

    <section class="panel">
      <header><div class="title">Data Table</div><div class="subtitle">Filter with the controls or type in the search box</div></header>
      <div class="table-wrap">
        <table id="dataTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

    <div class="footer-note">Source: Flow Monitoring data provided by user. Dashboard built with Leaflet & Chart.js.</div>
  </div>

<script>
/* ===========================
   1) DATA
   =========================== */
const monthLabels = [
  "2024-Jan","2024-Feb","2024-Mar","2024-Apr","2024-May","2024-Jun","2024-Jul","2024-Aug",
  "2024-Sep","2024-Oct","2024-Nov","2024-Dec",
  "2025-Jan","2025-Feb","2025-Mar","2025-Apr","2025-May","2025-Jun","2025-Jul","2025-Aug"
];

const raw = [
  // Direction, Point, Code, lat, lon, ...20 months...
  ["Incoming","Argin","SD17014PB3",21.988934,31.153322,496,628,4413,712,1555,1672,353,411,502,796,606,807,561,454,425,19950,21492,11329,16875,22604],
  ["Incoming","Ashkeet","SD17014PB4",22.000523,31.511477,0,482,5114,135,747,1481,167,152,513,728,5043,14905,22809,29072,19791,35074,14482,15636,21993,26116],
  ["Incoming","Adekonk","SD04115PB6",13.4623111,22.2296523,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5771],
  ["Incoming","Um Dukhun","SD06135PB5",11.139,22.966,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2835],
  ["Incoming","Gallabat","SD12077PB1",12.95798,36.151888,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,348],

  ["Outgoing","Argin","SD17014PB3",21.988934,31.153322,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,927],
  ["Outgoing","Ashkeet","SD17014PB4",22.000523,31.511477,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,519],
  ["Outgoing","Adekonk","SD04115PB6",13.4623111,22.2296523,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5493],
  ["Outgoing","Um Dukhun","SD06135PB5",11.139,22.966,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2127],
  ["Outgoing","Gallabat","SD12077PB1",12.95798,36.151888,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2667],
];

const rows = raw.map(r => {
  const base = {direction:r[0], point:r[1], code:r[2], lat:r[3], lon:r[4]};
  monthLabels.forEach((m, i) => base[m] = r[5+i] ?? 0);
  return base;
});

// Unique points (to populate dropdown etc.)
const points = [...new Set(rows.map(r => r.point))].map(p => {
  const any = rows.find(r => r.point === p);
  return { point:p, code:any.code, lat:any.lat, lon:any.lon };
});

/* ===========================
   2) STATE & HELPERS
   =========================== */
const $ = sel => document.querySelector(sel);
const directionSel = $('#direction');
const pointSel = $('#point');
const monthRange = $('#month');
const searchInput = $('#search');
const chipSelection = $('#chipSelection');
const tsSubtitle = $('#tsSubtitle');
const barSubtitle = $('#barSubtitle');

const kpiIncoming = $('#kpiIncoming');
const kpiOutgoing = $('#kpiOutgoing');
const kpiTotal = $('#kpiTotal');
const kpiNet = $('#kpiNet');
const kpiIncomingDelta = $('#kpiIncomingDelta');
const kpiOutgoingDelta = $('#kpiOutgoingDelta');
const kpiTotalDelta = $('#kpiTotalDelta');
const kpiNetDelta = $('#kpiNetDelta');

let map, markers = [];
let tsChart, barChart;

function fmt(n){ return n.toLocaleString('en-US'); }

function selectedMonthLabel(){ return monthLabels[parseInt(monthRange.value,10)]; }

function filterData(){
  const dir = directionSel.value; // Incoming, Outgoing, Both
  const selPoint = pointSel.value; // __ALL__ or name
  let arr = rows.slice();
  if (dir !== 'Both') arr = arr.filter(r => r.direction === dir);
  if (selPoint !== '__ALL__') arr = arr.filter(r => r.point === selPoint);
  return arr;
}

// Aggregate by month
function aggregateTimeSeries(dir, selPoint){
  const incoming = Array(monthLabels.length).fill(0);
  const outgoing = Array(monthLabels.length).fill(0);
  rows.forEach(r => {
    if (selPoint !== '__ALL__' && r.point !== selPoint) return;
    monthLabels.forEach((m, i) => {
      if (r.direction === 'Incoming') incoming[i] += r[m] || 0;
      else if (r.direction === 'Outgoing') outgoing[i] += r[m] || 0;
    });
  });
  if (dir === 'Incoming') return {labels:monthLabels, series:incoming, alt:outgoing};
  if (dir === 'Outgoing') return {labels:monthLabels, series:outgoing, alt:incoming};
  // Both
  const total = incoming.map((v,i)=> v + outgoing[i]);
  return {labels:monthLabels, series:total, incoming, outgoing};
}

function valueForPoint(r, month, dir){
  if (dir === 'Both') return r[month] || 0;
  if (r.direction !== dir) return 0;
  return r[month] || 0;
}

function computeKPIs(){
  const month = selectedMonthLabel();
  const prevIdx = Math.max(0, monthLabels.indexOf(month) - 1);
  const prevMonth = monthLabels[prevIdx];

  const selPoint = pointSel.value;
  const incoming = rows.filter(r => (selPoint==='__ALL__'||r.point===selPoint) && r.direction==='Incoming')
                       .reduce((s,r)=> s + (r[month]||0), 0);
  const outgoing = rows.filter(r => (selPoint==='__ALL__'||r.point===selPoint) && r.direction==='Outgoing')
                       .reduce((s,r)=> s + (r[month]||0), 0);
  const incomingPrev = rows.filter(r => (selPoint==='__ALL__'||r.point===selPoint) && r.direction==='Incoming')
                       .reduce((s,r)=> s + (r[prevMonth]||0), 0);
  const outgoingPrev = rows.filter(r => (selPoint==='__ALL__'||r.point===selPoint) && r.direction==='Outgoing')
                       .reduce((s,r)=> s + (r[prevMonth]||0), 0);

  const total = incoming + outgoing;
  const totalPrev = incomingPrev + outgoingPrev;
  const net = incoming - outgoing;
  const netPrev = incomingPrev - outgoingPrev;

  kpiIncoming.textContent = fmt(incoming);
  kpiOutgoing.textContent = fmt(outgoing);
  kpiTotal.textContent = fmt(total);
  kpiNet.textContent = fmt(net);

  function deltaStr(curr, prev){
    if (prev === 0) return 'vs prev. month: —';
    const pct = ((curr - prev)/prev)*100;
    const arrow = (pct>0?'▲': (pct<0?'▼':'•'));
    return `vs prev. month: ${arrow} ${pct.toFixed(1)}%`;
  }
  kpiIncomingDelta.textContent = deltaStr(incoming, incomingPrev);
  kpiOutgoingDelta.textContent = deltaStr(outgoing, outgoingPrev);
  kpiTotalDelta.textContent = deltaStr(total, totalPrev);
  kpiNetDelta.textContent = deltaStr(net, netPrev);
}

/* ===========================
   3) MAP
   =========================== */
function initMap(){
  map = L.map('map', { zoomControl:true, scrollWheelZoom:true }).setView([15.5, 30.0], 5);
  const tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap contributors'
  });
  tile.addTo(map);
  renderMarkers();
}

function scaleRadius(v){
  // Gentle sqrt scaling for large flows; ensure visibility for small numbers
  const r = Math.sqrt(v) * 0.35; // tweak as needed
  return Math.max(5, Math.min(r, 50));
}

function markerColor(){
  const dir = directionSel.value;
  if (dir === 'Incoming') return getComputedStyle(document.documentElement).getPropertyValue('--ok').trim();
  if (dir === 'Outgoing') return getComputedStyle(document.documentElement).getPropertyValue('--warn').trim();
  return getComputedStyle(document.documentElement).getPropertyValue('--both').trim();
}

function renderMarkers(){
  // clear old
  markers.forEach(m => m.remove());
  markers = [];

  const month = selectedMonthLabel();
  const dir = directionSel.value;
  const selPoint = pointSel.value;

  // Build point -> value for selected constraints
  const byPoint = new Map();
  rows.forEach(r=>{
    if (selPoint!=='__ALL__' && r.point!==selPoint) return;
    const key = r.point;
    const val = valueForPoint(r, month, dir);
    byPoint.set(key, (byPoint.get(key)||0) + val);
  });

  const col = markerColor();

  points.forEach(p=>{
    if (!byPoint.has(p.point)) return;
    const v = byPoint.get(p.point);
    const circle = L.circleMarker([p.lat, p.lon], {
      radius: scaleRadius(v),
      color: col, weight:1.5, fillColor: col, fillOpacity:.25
    }).addTo(map);

    const inc = rows.find(r => r.point===p.point && r.direction==='Incoming')?.[month] || 0;
    const out = rows.find(r => r.point===p.point && r.direction==='Outgoing')?.[month] || 0;

    const popup = `
      <div style="font-weight:800; margin-bottom:6px">${p.point}</div>
      <div style="font-size:12px; color:#555">Code: ${p.code}</div>
      <div style="margin-top:6px; font-size:13px">
        <div><b>${month}</b></div>
        <div>Incoming: <b style="color:var(--ok)">${fmt(inc)}</b></div>
        <div>Outgoing: <b style="color:var(--warn)">${fmt(out)}</b></div>
        <div>Total: <b>${fmt(inc+out)}</b></div>
        <div>Net (In−Out): <b>${fmt(inc-out)}</b></div>
      </div>
    `;
    circle.bindPopup(popup);
    markers.push(circle);
  });

  // if a single point selected, focus it
  if (selPoint !== '__ALL__'){
    const p = points.find(x=>x.point===selPoint);
    if (p) map.setView([p.lat, p.lon], 7);
  } else {
    // fit bounds to all visible circles if any
    if (markers.length){
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.15));
    }
  }
}

/* ===========================
   4) CHARTS
   =========================== */
function initCharts(){
  // Time series
  const tsCtx = document.getElementById('tsChart').getContext('2d');
  tsChart = new Chart(tsCtx, {
    type:'line',
    data:{ labels: monthLabels, datasets: [] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:true, labels:{ boxWidth:10 } } },
      interaction:{ mode:'index', intersect:false },
      scales:{
        x:{ ticks:{ maxRotation:0, autoSkip:true } },
        y:{ beginAtZero:true }
      }
    }
  });

  // Bar
  const barCtx = document.getElementById('barChart').getContext('2d');
  barChart = new Chart(barCtx, {
    type:'bar',
    data:{ labels:[], datasets:[ { label:'Flow', data:[] } ] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true } }
    }
  });

  renderCharts();
}

function renderCharts(){
  const dir = directionSel.value;
  const selPoint = pointSel.value;
  const month = selectedMonthLabel();
  const idx = monthLabels.indexOf(month);

  // Time series logic
  const agg = aggregateTimeSeries(dir, selPoint);
  tsChart.data.labels = agg.labels;

  if (dir === 'Both'){
    tsChart.data.datasets = [
      { label:'Incoming', data: agg.incoming, borderColor:getCss('--ok'), backgroundColor:getCss('--ok'), tension:.25 },
      { label:'Outgoing', data: agg.outgoing, borderColor:getCss('--warn'), backgroundColor:getCss('--warn'), tension:.25 },
      { label:'Total', data: agg.series, borderColor:getCss('--both'), backgroundColor:getCss('--both'), tension:.25 }
    ];
  } else {
    const c = (dir==='Incoming')?getCss('--ok'):getCss('--warn');
    tsChart.data.datasets = [
      { label:dir, data: agg.series, borderColor:c, backgroundColor:c, tension:.25 },
      { label:(dir==='Incoming'?'Outgoing':'Incoming'), data: agg.alt, borderColor:getCss('--muted'), backgroundColor:getCss('--muted'), borderDash:[6,4], tension:.25 }
    ];
  }
  tsChart.update();

  // Subtitle
  tsSubtitle.textContent = `${selPoint==='__ALL__'?'All points':selPoint} • ${dir} direction${dir==='Both'?'s':''}`;

  // Bar chart by point
  const labels = [];
  const vals = [];
  points.forEach(p=>{
    const inc = rows.find(r => r.point===p.point && r.direction==='Incoming')?.[month] || 0;
    const out = rows.find(r => r.point===p.point && r.direction==='Outgoing')?.[month] || 0;
    let v = (dir==='Incoming')?inc : (dir==='Outgoing'? out : inc+out);
    labels.push(p.point);
    vals.push(v);
  });

  barChart.data.labels = labels;
  barChart.data.datasets[0].data = vals;
  barChart.data.datasets[0].borderColor = (dir==='Incoming')?getCss('--ok'): (dir==='Outgoing'?getCss('--warn'):getCss('--both'));
  barChart.data.datasets[0].backgroundColor = barChart.data.datasets[0].borderColor;
  barChart.update();

  barSubtitle.textContent = `${month} • ${dir} direction${dir==='Both'?'s':''}`;
}

function getCss(varName){
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}

/* ===========================
   5) TABLE
   =========================== */
const tableHead = $('#tableHead');
const tableBody = $('#tableBody');

function buildTableHead(){
  const cols = ["Direction","Point","Code","Lat","Lon", ...monthLabels];
  const tr = document.createElement('tr');
  cols.forEach(c=>{
    const th = document.createElement('th'); th.textContent = c; tr.appendChild(th);
  });
  tableHead.innerHTML = ''; tableHead.appendChild(tr);
}

function renderTable(){
  const dir = directionSel.value;
  const selPoint = pointSel.value;
  const q = (searchInput.value || '').toLowerCase();

  let arr = rows.slice();
  if (dir !== 'Both') arr = arr.filter(r => r.direction === dir);
  if (selPoint !== '__ALL__') arr = arr.filter(r => r.point === selPoint);
  if (q) arr = arr.filter(r => (r.point + ' ' + r.code + ' ' + r.direction).toLowerCase().includes(q));

  tableBody.innerHTML = '';
  arr.forEach(r=>{
    const tr = document.createElement('tr');
    const base = [r.direction, r.point, r.code, r.lat, r.lon];
    base.forEach(v=>{
      const td = document.createElement('td'); td.textContent = v; tr.appendChild(td);
    });
    monthLabels.forEach(m=>{
      const td = document.createElement('td'); td.textContent = (r[m]||0).toLocaleString('en-US'); tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });
}

/* ===========================
   6) DOWNLOAD CSV
   =========================== */
function toCsv(){
  const cols = ["Direction","Point","Code","Lat","Lon", ...monthLabels];
  const lines = [cols.join(",")];
  rows.forEach(r=>{
    const vals = [r.direction, r.point, r.code, r.lat, r.lon, ...monthLabels.map(m=> r[m]||0)];
    lines.push(vals.join(","));
  });
  return lines.join("\n");
}

function downloadCsv(){
  const blob = new Blob([toCsv()], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'flow_monitoring_border_points.csv';
  a.click();
  URL.revokeObjectURL(url);
}

/* ===========================
   7) UI INIT & EVENTS
   =========================== */
function populatePointDropdown(){
  const sel = pointSel;
  points.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.point; opt.textContent = p.point;
    sel.appendChild(opt);
  });
}

function refreshAll(){
  // Chip text
  chipSelection.textContent = `${pointSel.value==='__ALL__'?'All Points':pointSel.value} • ${directionSel.value} • ${selectedMonthLabel()}`;

  computeKPIs();
  renderMarkers();
  renderCharts();
  renderTable();
}

function init(){
  populatePointDropdown();
  buildTableHead();
  initMap();
  initCharts();
  refreshAll();

  directionSel.addEventListener('change', refreshAll);
  pointSel.addEventListener('change', refreshAll);
  monthRange.addEventListener('input', refreshAll);
  searchInput.addEventListener('input', renderTable);
  document.getElementById('downloadCsvBtn').addEventListener('click', downloadCsv);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
