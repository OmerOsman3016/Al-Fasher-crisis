<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Sudan | Potential Displacement Routes from El Fasher</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>

  <style>
    :root{
      --brand-primary:#2a5885;   /* IOM deep blue */
      --brand-accent:#418FDE;    /* IOM accent blue */
      --line1:#ffb81c;           /* small flow */
      --line2:#ff671f;           /* medium */
      --line3:#d22630;           /* large */
      --surface:#f5f7fa;
    }

    html,body{height:100%;}
    body{margin:0;background:var(--surface);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;}
    #map{position:absolute;inset:0;}

    /* Header */
    .bar{
      position:fixed; left:0; right:0; top:0; z-index:1000;
      display:flex; align-items:center; gap:10px; padding:8px 12px;
      background:#fff; border-bottom:1px solid #e6edf5;
    }
    .bar h1{font-size:14px; margin:0; color:#1d2a36;}
    .bar small{color:#5a7086; font-weight:600;}

    /* Legend */
    .legend{
      position:fixed; bottom:14px; left:14px; z-index:1000;
      background:#fff; border:1px solid #d1dbe7; border-radius:10px; padding:8px 10px;
      box-shadow:0 2px 10px rgba(0,0,0,.06); font-size:12px; color:#334a62;
    }

    /* Origin pulsing marker */
    .origin-pulse-icon{ pointer-events:auto; }
    .origin-pulse-icon .pulse{
      position:relative; width:30px; height:30px; border-radius:50%;
      background: radial-gradient(circle at 50% 45%, rgba(255,255,255,.95) 0 28%, rgba(255,103,31,1) 32%, rgba(255,103,31,.92) 60%, rgba(255,103,31,.85) 100%);
      box-shadow: 0 0 0 2px #ffffff inset, 0 2px 8px rgba(0,0,0,.18);
    }
    .origin-pulse-icon .pulse::before,
    .origin-pulse-icon .pulse::after{
      content:""; position:absolute; left:50%; top:50%; width:100%; height:100%;
      border-radius:50%; transform:translate(-50%,-50%) scale(.7); border:2px solid rgba(255,103,31,.7);
      animation:pulseRing 2.2s ease-out infinite;
    }
    .origin-pulse-icon .pulse::after{ animation-delay:1.1s; }
    @keyframes pulseRing {
      0% { transform:translate(-50%,-50%) scale(.7); opacity:.9; }
      70% { opacity:.2; }
      100% { transform:translate(-50%,-50%) scale(2.1); opacity:0; }
    }

    /* Destination glowing dots */
    .dest-icon{ pointer-events:auto; transition:transform .12s ease; }
    .dest-icon .dot{
      position:relative; width:22px; height:22px; border-radius:50%;
      background: radial-gradient(circle at 45% 30%, rgba(255,255,255,.95) 0 28%, rgba(65,143,222,1) 32%, rgba(65,143,222,.92) 60%, rgba(65,143,222,.85) 100%);
      border:1px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,.06), 0 0 10px rgba(65,143,222,.35);
    }
    .dest-icon .dot::after{
      content:""; position:absolute; left:35%; top:28%; width:18%; height:18%;
      background:rgba(255,255,255,.9); border-radius:50%; filter:blur(.3px);
    }
    .dest-icon:hover{ transform:scale(1.1); }
  </style>
</head>
<body>
  <div class="bar">
    <h1>Potential Displacement Routes from <strong>El Fasher</strong></h1>
    <small>→ Tawila (SD02170) • At Tina (SD02171)</small>
  </div>
  <div id="map" role="region" aria-label="Map of potential displacement routes from El Fasher"></div>

  <div class="legend">
    <div style="font-weight:700; margin-bottom:6px; color:#1d2a36">Legend</div>
    <div style="display:grid;grid-template-columns:18px 1fr;gap:8px;align-items:center;margin-bottom:4px">
      <span style="height:4px;background:var(--line3)"></span><span>Potential route</span>
      <span style="width:12px;height:12px;border-radius:50%;background:#ff671f;display:inline-block;box-shadow:0 0 0 2px #fff inset;"></span>
      <span>Origin (El Fasher)</span>
      <span style="width:12px;height:12px;border-radius:50%;background:#418FDE;display:inline-block;border:1px solid #fff;box-shadow:0 0 8px rgba(65,143,222,.35)"></span>
      <span>Destinations</span>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Local CanvasFlowmapLayer (change path if yours differs) -->
  <script src="./src/CanvasFlowmapLayer.js"></script>

  <script>
  (function(){
    const MAPBOX_TOKEN = 'pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q';

    // ---- DATA (inline) -------------------------------------------------
    const origin = { id:'ELFASHER', name:'El Fasher', lat:13.636, lon:25.349 };
    const destinations = [
      { id:'SD02170', name:'Tawila', lat:13.351266, lon:24.856704 },
      { id:'SD02171', name:'At Tina', lat:15.167895, lon:23.127019 }
    ];

    // Build a small FC for CanvasFlowmapLayer
    const features = destinations.map((d, i) => ({
      type:'Feature',
      geometry:{ type:'Point', coordinates:[origin.lon, origin.lat] },
      properties:{
        s_state_id: origin.id, s_State: origin.name, s_lat: origin.lat, s_lon: origin.lon,
        e_locality_id: d.id, e_locality: d.name, e_lat: d.lat, e_lon: d.lon,
        // give a tiny "volume" just to pass class breaks; both use same style anyway
        e_Volume: 100 + i * 10
      }
    }));
    const fc = { type:'FeatureCollection', features };

    // ---- MAP -----------------------------------------------------------
    const map = L.map('map', { preferCanvas:true, zoomControl:false }).setView([14.4, 24.8], 6);

    const mbSat = L.tileLayer(
      `https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`,
      { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' }
    ).addTo(map);

    L.control.zoom({ position:'bottomright' }).addTo(map);
    L.control.scale({ position:'bottomleft', metric:true, imperial:false }).addTo(map);

    // ---- Pulsing origin marker ----------------------------------------
    const originIcon = L.divIcon({
      className:'origin-pulse-icon',
      html:`<div class="pulse"></div>`,
      iconSize:[30,30], iconAnchor:[15,15]
    });
    L.marker([origin.lat, origin.lon], { icon: originIcon })
      .bindTooltip(`Origin: ${origin.name}`, { direction:'top', offset:[0,-4] })
      .addTo(map);

    // ---- Destinations markers -----------------------------------------
    const destLayer = L.layerGroup().addTo(map);
    destinations.forEach(d => {
      const icon = L.divIcon({
        className:'dest-icon',
        html:`<div class="dot"></div>`,
        iconSize:[22,22], iconAnchor:[11,11]
      });
      L.marker([d.lat, d.lon], { icon })
        .bindTooltip(`${d.name} • ${d.id}`, { direction:'top', offset:[0,-8] })
        .bindPopup(`<strong>${d.name}</strong><br><small>Code: ${d.id}</small>`)
        .addTo(destLayer);
    });

    // ---- Flow lines (CanvasFlowmapLayer) -------------------------------
    const flowmapLayer = L.canvasFlowmapLayer(fc, {
      originAndDestinationFieldIds:{
        originUniqueIdField:'s_state_id',
        originGeometry:{ x:'s_lon', y:'s_lat' },
        destinationUniqueIdField:'e_locality_id',
        destinationGeometry:{ x:'e_lon', y:'e_lat' }
      },
      // destination markers handled above; hide internal points
      pointToLayer:(feature, latlng)=> L.circleMarker(latlng, { radius:0.01, opacity:0, fillOpacity:0 }),
      canvasBezierStyle:{
        type:'classBreaks', field:'e_Volume',
        classBreakInfos:[
          { classMinValue:1, classMaxValue:2000000, symbol:{ strokeStyle:getCSS('--line3','#d22630'), lineWidth:3, lineCap:'round', shadowColor:'#e34a33', shadowBlur:2 } }
        ],
        defaultSymbol:{ strokeStyle:'#d22630', lineWidth:3, lineCap:'round', shadowColor:'#e34a33', shadowBlur:2 }
      },
      pathDisplayMode:'all',
      animationStarted:true,
      animationEasingFamily:'Linear',
      animationEasingType:'None',
      animationDuration:3200,
      onEachFeature:(feature, layer)=>{
        const to = feature.properties.e_locality;
        layer.bindTooltip(`Route to ${to}`, { direction:'top' });
      }
    }).addTo(map);

    // Focus/selection when clicking a destination marker
    destLayer.eachLayer(m=>{
      m.on('click', ()=>{
        const name = m.getTooltip()?.getContent()?.split(' • ')?.[0] || '';
        const dest = destinations.find(d => d.name === name) || null;
        if (dest && flowmapLayer?.selectFeaturesForPathDisplayById){
          try { flowmapLayer.selectFeaturesForPathDisplayById('e_locality_id', dest.id, true, 'SELECTION_NEW'); } catch {}
        }
      });
    });

    // Fit bounds around origin + destinations
    const bounds = L.latLngBounds([ [origin.lat, origin.lon] ]);
    destinations.forEach(d => bounds.extend([d.lat, d.lon]));
    map.fitBounds(bounds.pad(0.2));

    // ---- Helpers -------------------------------------------------------
    function getCSS(varName, fallback){
      const v = getComputedStyle(document.documentElement).getPropertyValue(varName);
      return (v && v.trim()) ? v.trim() : fallback;
    }
  })();
  </script>
</body>
</html>
