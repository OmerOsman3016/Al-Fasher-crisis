<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>Sudan | IDPs Pathways Dashboard</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin="anonymous"
  />
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <!-- IOM digital typeface -->
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap"
    rel="stylesheet"
  />

  <style>
    :root{
      /* IOM primary + shades */
      --iom-blue:#0033A0; --iom-blue-60:#4066B8; --iom-blue-40:#8099D0; --iom-blue-20:#B3C2E3; --iom-blue-10:#D9E0F1;
      --blue-box:#E9EBF6;

      /* IOM secondary set */
      --un-blue:#418FDE; --yellow:#FFB81C; --orange:#FF671F; --red:#D22630; --mint:#5CB8B2;

      /* Map/UI tokens */
      --brand-primary:var(--iom-blue);
      --brand-accent:var(--un-blue);
      --brand-amber:var(--yellow);

      --surface:#f5f7fa;

      /* Flow ramp */
      --line1:var(--yellow);
      --line2:var(--orange);
      --line3:var(--red);

      /* Scenario routes */
      --potential:var(--mint);

      /* Layout */
      --sidebar-w: 340px;
    }

    html, body { height:100%; }
    body{
      margin:0; background:var(--surface); color:#1d2a36;
      font-family:'Open Sans', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      display:flex; flex-direction:column; min-height:100vh;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ─── Header ─────────────────────────────────────────────────────── */
    .app-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 16px; background:#fff; border-bottom:1px solid #e6edf5; position:relative;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .app-header::after{
      content:""; position:absolute; left:0; right:0; bottom:-2px; height:2px;
      background:linear-gradient(90deg,var(--brand-primary),var(--brand-accent));
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand .logo{ width:36px; height:24px; border-radius:4px; overflow:hidden; display:block; box-shadow:0 0 0 1px #d1dbe7 inset; }
    .brand .logo svg{ width:100%; height:100%; display:block; }
    .brand h1{ font-size:16px; line-height:1.15; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:800; color:#0e2a5a; }
    .brand .sub{ font-size:12px; color:#5a7086; font-weight:600; letter-spacing:.2px; }

    .header-actions{ display:flex; align-items:center; gap:8px; }
    .btn{
      display:inline-flex; align-items:center; gap:8px; border:1px solid #d1dbe7; background:#fff; color:#1d2a36;
      padding:6px 10px; border-radius:10px; font-size:12px; font-weight:700; cursor:pointer; user-select:none; transition:.2s ease;
    }
    .btn:hover{ border-color:#b7c6da; box-shadow:0 1px 0 rgba(0,0,0,.03); }
    .btn.active{ border-color:var(--brand-accent); background:#eef6ff; }

    /* ─── Dashboard layout ───────────────────────────────────────────── */
    .dash{
      display:grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      gap:12px;
      padding:12px;
      flex:1 1 auto;
      min-height:0;
    }

    aside.sidebar{
      background:#fff; border:1px solid #e6edf5; border-radius:12px; padding:12px;
      box-shadow:0 1px 10px rgba(0,0,0,.04);
      display:flex; flex-direction:column; gap:12px; min-height:0;
    }
    .block{
      border:1px solid #e6edf5; border-radius:10px; padding:12px; background:#fff;
    }
    .block h3{
      margin:0 0 8px; font-size:13px; color:#244b6b; font-weight:800; letter-spacing:.2px;
    }
    .control-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin:8px 0; font-size:13px; }
    .control-row label{ display:flex; align-items:center; gap:8px; cursor:pointer; }

    .legend{
      display:grid; grid-template-columns:18px 1fr; gap:8px 10px; align-items:center; font-size:12px; color:#3c4f62;
    }
    .legend .sw{ height:4px; border-radius:2px; }
    .legend .pt{ width:12px; height:12px; border-radius:50%; display:inline-block; }

    main.content{
      display:grid;
      grid-template-rows: auto 1fr;
      gap:12px; min-height:0;
    }

    .kpis{
      display:grid; grid-template-columns: repeat(4, minmax(160px,1fr)); gap:12px;
    }
    .kpi{
      background:#fff; border:1px solid #e6edf5; border-radius:12px; padding:12px; box-shadow:0 1px 10px rgba(0,0,0,.04);
    }
    .kpi .label{ font-size:12px; color:#5a7086; font-weight:700; }
    .kpi .value{ font-size:22px; font-weight:800; color:#1d2a36; line-height:1.1; margin-top:4px; }
    .kpi .sub{ font-size:11px; color:#6a7f94; margin-top:4px; }

    .map-and-table{
      display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px; min-height:0;
    }
    .map-card, .table-card{
      background:#fff; border:1px solid #e6edf5; border-radius:12px; box-shadow:0 1px 10px rgba(0,0,0,.04);
      display:flex; flex-direction:column; min-height:0; overflow:hidden;
    }
    .card-h{ padding:10px 12px; border-bottom:1px solid #eef2f7; font-weight:800; color:#244b6b; }
    .card-b{ position:relative; flex:1 1 auto; min-height:0; }
    #map{ position:absolute; inset:0; }

    .table-wrap{ padding:8px 12px; overflow:auto; }
    table{ border-collapse:separate; border-spacing:0 8px; width:100%; font-size:13px; }
    thead th{ text-align:left; color:#5a7086; font-weight:700; padding:4px 6px; position:sticky; top:0; background:#fff; }
    tbody tr{ background:#f9fbff; border:1px solid #e6edf5; }
    tbody td{ padding:8px 6px; }
    tbody tr:hover{ background:#eef6ff; cursor:pointer; }

    .loading-overlay{
      position:absolute; inset:0; z-index:1100; background:rgba(255,255,255,.9);
      display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
    }
    .spinner{
      width:44px; height:44px; border:4px solid #e7eef7; border-top-color:var(--brand-primary);
      border-radius:50%; animation:spin 1s linear infinite; margin-bottom:10px;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Origin pulsing */
    .origin-pulse-icon .pulse{
      position:relative; width:var(--d,24px); height:var(--d,24px); border-radius:50%;
      background: radial-gradient(circle at 50% 45%, rgba(255,255,255,.95) 0 28%, rgba(255,103,31,1) 32%, rgba(255,103,31,.92) 60%, rgba(255,103,31,.85) 100%);
      box-shadow: 0 0 0 2px #ffffff inset, 0 2px 8px rgba(0,0,0,.18);
    }
    .origin-pulse-icon .pulse::before,
    .origin-pulse-icon .pulse::after{
      content:""; position:absolute; left:50%; top:50%; width:100%; height:100%;
      border-radius:50%; transform:translate(-50%,-50%) scale(.7); border:2px solid rgba(255,103,31,.7);
      animation:pulseRing 2.2s ease-out infinite;
    }
    .origin-pulse-icon .pulse::after{ animation-delay:1.1s; }
    @keyframes pulseRing {
      0% { transform:translate(-50%,-50%) scale(.7); opacity:.9; }
      70% { opacity:.2; }
      100% { transform:translate(-50%,-50%) scale(2.1); opacity:0; }
    }

    /* Destination glow icons */
    .dest-icon{ pointer-events:auto; transition:transform .12s ease; }
    .dest-icon .dot{
      position:relative; width:var(--d,18px); height:var(--d,18px); border-radius:50%;
      background: radial-gradient(circle at 45% 30%, rgba(255,255,255,.95) 0 28%, rgba(65,143,222,1) 32%, rgba(65,143,222,.92) 60%, rgba(65,143,222,.85) 100%);
      border:1px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,.06), 0 0 10px rgba(65,143,222,.35);
    }
    .dest-icon:hover{ transform:scale(1.1); }
    .dest-icon.focus{ transform:scale(1.18); box-shadow:0 0 0 2px rgba(65,143,222,.25); }

    /* Tooltips & popups */
    .leaflet-tooltip.state-label{
      background:transparent; border:none; box-shadow:none; padding:0;
      color:#244b6b; font-weight:600; font-size:12px; letter-spacing:.2px;
      text-shadow: 0 0 2px #fff, 0 0 3px #fff, 0 0 4px #fff, 0 0 5px #fff;
      pointer-events:none;
    }
    .leaflet-popup-content-wrapper { border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.12); }
    .leaflet-popup-content { margin:16px; line-height:1.5; font-size:14px; }
    .leaflet-popup-content h4 { margin:0 0 12px; color:var(--brand-primary); font-weight:700; font-size:16px; }
    .leaflet-popup-content p { margin:0 0 10px; }
    .leaflet-popup-content small { color:#5a7086; }

    /* Responsive */
    @media (max-width:1100px){
      .map-and-table{ grid-template-columns: 1fr; }
    }
    @media (max-width:900px){
      .dash{ grid-template-columns: 1fr; }
      aside.sidebar{ order:2; }
      main.content{ order:1; }
      .kpis{ grid-template-columns: repeat(2,1fr); }
    }
    @media (max-width:560px){
      .kpis{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="app-header" role="banner">
    <div class="brand" title="Sudan | IDPs Pathways Dashboard">
      <div class="logo" role="img" aria-label="Sudan flag">
        <svg viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
          <rect width="3" height="2" fill="#000"/>
          <rect width="3" height="1.3333" y="0.3333" fill="#ffffff"/>
          <rect width="3" height="0.6667" fill="#D21034"/>
          <polygon points="0,0 0,2 1,1" fill="#007229"/>
        </svg>
      </div>
      <div>
        <h1>Sudan | Al Fasher Crisis</h1>
        <div class="sub">Dashboard of displacement flows and key indicators</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="btn-reset" class="btn" title="Reset view (R)"><i class="fa-solid fa-rotate"></i><span>Reset</span></button>
      <button id="btn-help" class="btn" title="Help"><i class="fa-solid fa-circle-question"></i><span>Help</span></button>
    </div>
  </header>

  <!-- Dashboard -->
  <div class="dash">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Filters and legend">
      <div class="block">
        <h3>Layers & Filters</h3>
        <div class="control-row">
          <label><input type="checkbox" id="chk-flows" checked> Flow lines</label>
          <span class="hint"></span>
        </div>
        <div class="control-row">
          <label><input type="checkbox" id="chk-points" checked> Points</label>
          <span></span>
        </div>
        <div class="control-row">
          <label><input type="checkbox" id="chk-routes"> Potential routes</label>
          <span></span>
        </div>
        <div class="control-row">
          <label for="min-volume">Min. flow volume</label>
          <input type="number" id="min-volume" value="1" min="1" step="1000" style="width:110px;">
        </div>
        <div class="control-row">
          <label for="basemap">Basemap</label>
          <select id="basemap" style="width:140px;">
            <option value="mbLight" selected>Mapbox Light</option>
            <option value="mbStreets">Mapbox Streets</option>
            <option value="mbOutdoor">Mapbox Outdoors</option>
            <option value="mbSat">Mapbox Satellite</option>
            <option value="cartoLight">Carto Light</option>
            <option value="mbCustom">Mapbox Custom</option>
          </select>
        </div>
      </div>

      <div class="block">
        <h3>Legend</h3>
        <div class="legend">
          <span class="sw" style="background:var(--line1)"></span><span>1 — 50,000</span>
          <span class="sw" style="background:var(--line2)"></span><span>50,000 — 100,000</span>
          <span class="sw" style="background:var(--line3)"></span><span>100,000 — 1,600,000</span>
          <span class="sw" style="background:var(--potential)"></span><span>Potential route</span>
          <span class="pt" style="background:#ff671f; box-shadow:0 0 0 2px #fff inset"></span><span>Origin state (pulsing)</span>
          <span class="pt" style="background:var(--brand-accent); box-shadow:0 0 8px rgba(65,143,222,.35)"></span><span>Destination locality</span>
        </div>
      </div>

      <div class="block">
        <h3>About</h3>
        <div style="font-size:12px; color:#334a62; line-height:1.45">
          IOM DTM prototype. Click a state to focus its outbound flows, or click a destination bubble to focus inbound flows. Use “Min. flow volume” to hide small lines.
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="content">
      <!-- KPIs -->
      <section class="kpis" aria-label="Key indicators">
        <div class="kpi">
          <div class="label">Total displaced (sum flows)</div>
          <div class="value" id="kpi-total">—</div>
          <div class="sub">From all origin states</div>
        </div>
        <div class="kpi">
          <div class="label">Origin states</div>
          <div class="value" id="kpi-origins">—</div>
          <div class="sub">Unique origins in dataset</div>
        </div>
        <div class="kpi">
          <div class="label">Destination localities</div>
          <div class="value" id="kpi-dests">—</div>
          <div class="sub">Unique destinations in dataset</div>
        </div>
        <div class="kpi">
          <div class="label">Active displacement flows</div>
          <div class="value" id="kpi-flows">—</div>
          <div class="sub">Rows after filters</div>
        </div>
      </section>

      <!-- Map + Table -->
      <section class="map-and-table">
        <div class="map-card" aria-label="Map">
          <div class="card-h">Map</div>
          <div class="card-b">
            <div id="map" role="region" aria-label="IDPs Pathways map of Sudan"></div>
            <div class="loading-overlay" id="loading-overlay" aria-live="polite">
              <div class="spinner" aria-hidden="true"></div>
              <div>Loading displacement data…</div>
            </div>
          </div>
        </div>

        <div class="table-card" aria-label="Top destinations">
          <div class="card-h">Top destinations</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:36px;">#</th>
                  <th>Locality</th>
                  <th style="text-align:right;">Total linked displaced</th>
                </tr>
              </thead>
              <tbody id="tbl-dests"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- JS libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <!-- Local CanvasFlowmapLayer -->
  <script src="./src/CanvasFlowmapLayer.js"></script>

  <script>
  (function(){
    const MAPBOX_TOKEN = 'pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q';

    // Map init
    const map = L.map('map', {
      preferCanvas:true, zoomControl:false, minZoom:4, maxZoom:11, zoomSnap:0.5, zoomDelta:0.5, attributionControl:true
    }).setView([16,30], 5.5);

    // Basemaps
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap & CartoDB' });
    const mbLight   = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`,   { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbStreets = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbSat     = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbOutdoor = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/outdoors-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbCustom  = L.tileLayer(`https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    mbLight.addTo(map);

    // Zoom & scale
    L.control.scale({ position:'bottomleft', metric:true, imperial:false }).addTo(map);
    L.control.zoom({ position:'bottomright' }).addTo(map);

    // UI elements
    const overlay = document.getElementById('loading-overlay');
    const chkFlows  = document.getElementById('chk-flows');
    const chkPoints = document.getElementById('chk-points');
    const chkRoutes = document.getElementById('chk-routes');
    const minVolumeInput = document.getElementById('min-volume');
    const basemapSel = document.getElementById('basemap');

    const btnReset = document.getElementById('btn-reset');
    const btnHelp  = document.getElementById('btn-help');

    btnReset.addEventListener('click', ()=> map.setView([16,30], 5.5));
    window.addEventListener('keydown', (e) => {
      if (e.target && e.target.closest && e.target.closest('input, select, textarea, [contenteditable="true"]')) return;
      const k = (e.key || '').toLowerCase();
      if (k === 'r') map.setView([16,30], 5.5);
    });
    btnHelp.addEventListener('click', ()=> {
      alert(`Dashboard tips:
- Toggle Flow lines / Points / Potential routes in the sidebar.
- Click a state to focus its outbound flows.
- Click a destination bubble or a table row to focus inbound flows.
- Set a 'Min. flow volume' to hide small links.
- Reset (R) returns to the country view.`);
    });

    // Basemap switcher
    basemapSel.addEventListener('change', ()=> {
      const v = basemapSel.value;
      [cartoLight, mbLight, mbStreets, mbSat, mbOutdoor, mbCustom].forEach(l => { if (map.hasLayer(l)) map.removeLayer(l); });
      ({cartoLight, mbLight, mbStreets, mbSat, mbOutdoor, mbCustom}[v]).addTo(map);
    });

    // State
    let stateBoundariesLayer, admin1Labels;
    let flowmapLayer, originPulseLayer;
    let crisisLayer, campsLayer, siegeRing;
    let routesGroup = null, routesLayer = null, routesMarkers = null, routesOrigin = null, routesVisible = false;

    let allRows = [];
    let filteredRows = [];
    let destAgg = [];
    let originTotals, destinationTotals;

    // Load data
    Promise.all([
      fetch('./data/ADMIN1.json').then(r => (r.ok ? r.json() : null)).catch(()=>null),
      fetch('./data/sudan_states.geojson').then(r => (r.ok ? r.json() : null)).catch(()=>null),
      new Promise((resolve, reject) => {
        Papa.parse('./data/IDPs_Pathway.csv', {
          download:true, header:true, dynamicTyping:true, skipEmptyLines:true,
          complete: res => resolve(res.data), error: reject
        });
      })
    ]).then(([admin1Maybe, fallbackStates, rows]) => {
      const states = toGeoJSON(admin1Maybe) || toGeoJSON(fallbackStates);
      if (states) addStyledAdmin1(states);

      // Normalize + store
      allRows = rows.map(r => normalizeRow(r))
        .filter(r => Number.isFinite(r.s_lat) && Number.isFinite(r.s_lon) &&
                     Number.isFinite(r.e_lat) && Number.isFinite(r.e_lon) &&
                     Number.isFinite(r.e_Volume) && r.e_Volume > 0);

      applyFiltersAndRender();

      overlay.style.display = 'none';

      // Crisis ring (optional) – subtle and static
      addCrisisFacts();
      // Prepare potential routes (not visible by default)
      setupPotentialRoutes();

    }).catch(err => {
      overlay.innerHTML = '<div style="color:#b00020;text-align:center">Failed to load data. Check console.</div>';
      console.error(err);
    });

    // Filter logic
    chkFlows.addEventListener('change', ()=> flowmapLayer?.setPathDisplayMode?.(chkFlows.checked ? 'all' : 'none'));
    chkPoints.addEventListener('change', ()=> {
      flowmapLayer?.setPointVisibility?.(chkPoints.checked);
      if (originPulseLayer){
        if (chkPoints.checked && !map.hasLayer(originPulseLayer)) originPulseLayer.addTo(map);
        if (!chkPoints.checked && map.hasLayer(originPulseLayer)) map.removeLayer(originPulseLayer);
      }
    });
    chkRoutes.addEventListener('change', toggleRoutes);
    minVolumeInput.addEventListener('change', ()=> applyFiltersAndRender());

    function applyFiltersAndRender(){
      const minV = Math.max(1, Number(minVolumeInput.value) || 1);
      filteredRows = allRows.filter(r => r.e_Volume >= minV);

      const totals = computeTotals(filteredRows);
      destinationTotals = totals.destinationTotals;
      originTotals = totals.originTotals;
      destAgg = totals.destAgg;

      // Attach totals to rows (for marker sizes)
      filteredRows.forEach(d => {
        d.e_totalVolume = destinationTotals.get(d.e_locality_id) || d.e_Volume;
        d.s_totalVolume = originTotals.get(d.s_state_id) || d.e_Volume;
      });

      // (Re)build layers
      if (originPulseLayer){ map.removeLayer(originPulseLayer); originPulseLayer = null; }
      if (flowmapLayer){ map.removeLayer(flowmapLayer); flowmapLayer = null; }

      addOriginPulseLayer(filteredRows);
      initFlowmap(filteredRows);

      // Update KPIs & table
      updateKPIs(filteredRows, originTotals, destinationTotals);
      buildTopDestTable(destAgg);

      // Respect toggles
      flowmapLayer?.setPathDisplayMode?.(chkFlows.checked ? 'all' : 'none');
      flowmapLayer?.setPointVisibility?.(chkPoints.checked);
    }

    function updateKPIs(data, originTotals, destinationTotals){
      const totalDisplaced = Array.from(originTotals.values()).reduce((s,v)=>s+v,0);
      document.getElementById('kpi-total').textContent   = totalDisplaced.toLocaleString();
      document.getElementById('kpi-origins').textContent = originTotals.size.toLocaleString();
      document.getElementById('kpi-dests').textContent   = destinationTotals.size.toLocaleString();
      document.getElementById('kpi-flows').textContent   = data.length.toLocaleString();
    }

    function buildTopDestTable(destAgg){
      const tbody = document.getElementById('tbl-dests');
      tbody.innerHTML = '';
      const top = destAgg.slice().sort((a,b)=> b.total - a.total).slice(0, 15);
      top.forEach((d,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${escapeHtml(d.name)}</td>
          <td style="text-align:right;">${formatNumber(d.total)}</td>
        `;
        tr.title = 'Click to focus flows to this destination';
        tr.addEventListener('click', ()=>{
          try{
            flowmapLayer?.selectFeaturesForPathDisplayById?.('e_locality_id', String(d.id), true, 'SELECTION_NEW');
            map.flyTo([d.lat, d.lon], Math.max(map.getZoom()||8, 9), {duration: 0.8});
          }catch{}
        });
        tbody.appendChild(tr);
      });
    }

    // ---- Admin1 styled layer (with hover) ------------------------------
    function addStyledAdmin1(states){
      map.createPane('admin1-casing');  map.getPane('admin1-casing').style.zIndex = 350;
      map.createPane('admin1-stroke');  map.getPane('admin1-stroke').style.zIndex = 351;
      map.createPane('admin1-labels');  map.getPane('admin1-labels').style.zIndex = 352;

      function strokeWeightForZoom(z){ return Math.max(0.8, Math.min(2.4, (z - 4) * 0.35)); }

      const admin1StrokeStyle = () => ({
        pane:'admin1-stroke', color: getCSS('--brand-primary','#2a5885'),
        weight: strokeWeightForZoom(map.getZoom()), opacity:0.95,
        fillColor:'#eaf2fb', fillOpacity:0.25, lineJoin:'round', lineCap:'round', smoothFactor:0.4, interactive:true
      });

      const admin1CasingStyle = () => ({
        pane:'admin1-casing', color:'#ffffff',
        weight: strokeWeightForZoom(map.getZoom()) + 2, opacity:0.9, fillOpacity:0,
        lineJoin:'round', lineCap:'round', smoothFactor:0.4, interactive:false
      });

      const admin1Casing = L.geoJSON(states, { style: admin1CasingStyle, interactive:false });
      const admin1Stroke = L.geoJSON(states, {
        style: admin1StrokeStyle,
        onEachFeature: (feat, lyr) => {
          const nm = getAdmin1Name(feat?.properties) || 'Admin 1';
          lyr.on({
            mouseover:e=>{
              e.target.setStyle({
                color: getCSS('--brand-amber','#ffb81c'),
                weight: strokeWeightForZoom(map.getZoom()) + 1.2,
                fillOpacity:0.35
              });
              e.target.bringToFront();
            },
            mouseout:()=>admin1Stroke.resetStyle(lyr),
            click:e=>{
              try { map.fitBounds(e.target.getBounds(), { padding:[20,20] }); } catch{}
              const code = getAdmin1Code(feat?.properties);
              if (code && flowmapLayer?.selectFeaturesForPathDisplayById){
                try { flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', String(code), true, 'SELECTION_NEW'); } catch {}
              }
            }
          });
          lyr.bindTooltip(nm, { sticky:true });
        }
      });

      admin1Labels = L.layerGroup([], { pane:'admin1-labels' });
      function rebuildLabels(){
        admin1Labels.clearLayers();
        if (map.getZoom() < 6) return;
        admin1Stroke.eachLayer(l => {
          const nm = getAdmin1Name(l.feature?.properties) || '';
          if (!nm) return;
          const c = safeCenter(l); if (!c) return;
          L.tooltip({ permanent:true, direction:'center', className:'state-label', pane:'admin1-labels' })
            .setContent(nm).setLatLng(c).addTo(admin1Labels);
        });
      }

      stateBoundariesLayer = L.featureGroup([admin1Casing, admin1Stroke]).addTo(map);
      stateBoundariesLayer.bringToBack();
      try { map.fitBounds(stateBoundariesLayer.getBounds(), { padding:[20,20] }); } catch {}

      rebuildLabels(); admin1Labels.addTo(map);

      map.on('zoomend', ()=>{
        admin1Casing.setStyle(admin1CasingStyle());
        admin1Stroke.setStyle(admin1StrokeStyle());
        rebuildLabels();
      });
    }

    // ---- Origin pulsing layer ------------------------------------------
    function addOriginPulseLayer(rows){
      map.createPane('origin-pulses'); map.getPane('origin-pulses').style.zIndex = 460;

      const byState = new Map();
      for (const d of rows){
        if (!d.s_state_id) continue;
        if (!byState.has(d.s_state_id)){
          byState.set(d.s_state_id, { id:d.s_state_id, lat:d.s_lat, lon:d.s_lon, name:d.s_State||'Unknown', total:0 });
        }
        byState.get(d.s_state_id).total += Number(d.e_Volume)||0;
      }

      originPulseLayer = L.layerGroup([], { pane:'origin-pulses' });

      const totals = [...byState.values()].map(v => v.total);
      const tMin = Math.max(1, Math.min(...totals));
      const tMax = Math.max(...totals);
      const sizeFor = (v) => Math.round(scaleRadiusLog(v, tMin, tMax, 12, 28) * 2);

      byState.forEach((v) => {
        const size = sizeFor(v.total);
        const icon = L.divIcon({
          className: 'origin-pulse-icon',
          html: `<div class="pulse" style="--d:${size}px"></div>`,
          iconSize: [size, size], iconAnchor: [size/2, size/2]
        });

        const m = L.marker([v.lat, v.lon], { icon })
          .bindTooltip(`Displacement Origin: ${escapeHtml(v.name)}<br>Total displaced: ${formatNumber(v.total)}`, { direction:'top', offset:[0,-4] })
          .on('click', () => {
            try { flowmapLayer?.selectFeaturesForPathDisplayById?.('s_state_id', String(v.id), true, 'SELECTION_NEW'); } catch {}
          })
          .bindPopup(`
            <div style="min-width:220px">
              <h4 style="margin:0 0 8px;color:var(--brand-primary);font-weight:800">Displacement Origin</h4>
              <p style="margin:0 0 6px"><strong>State:</strong> ${escapeHtml(v.name)}</p>
              <p style="margin:0 0 0"><strong>Total Displaced:</strong> ${formatNumber(v.total)}</p>
            </div>`);

        originPulseLayer.addLayer(m);
      });

      originPulseLayer.addTo(map);
    }

    // ---- Flowmap (no animation) ----------------------------------------
    function initFlowmap(data){
      const originKeySet = new Set(data.map(d => latlonKey(d.s_lat, d.s_lon)));
      const fc = { type:'FeatureCollection', features: data.map(d => ({
        type:'Feature', geometry:{ type:'Point', coordinates:[d.s_lon, d.s_lat] }, properties:d
      })) };

      flowmapLayer = L.canvasFlowmapLayer(fc, {
        originAndDestinationFieldIds:{
          originUniqueIdField:'s_state_id',
          originGeometry:{ x:'s_lon', y:'s_lat' },
          destinationUniqueIdField:'e_locality_id',
          destinationGeometry:{ x:'e_lon', y:'e_lat' }
        },
        pointToLayer:(feature, latlng)=>{
          const isOriginSpot = originKeySet.has(latlonKey(latlng.lat, latlng.lng));
          if (isOriginSpot){
            return L.circleMarker(latlng, { radius:0.1, opacity:0, fillOpacity:0 });
          }
          const vol = feature.properties?.e_totalVolume || feature.properties?.e_Volume || 0;
          const d = Math.round(scaleRadiusLog(vol, 20000, 1600000, 10, 22));
          const icon = L.divIcon({
            className:'dest-icon',
            html:`<div class="dot" style="--d:${d}px"></div>`,
            iconSize:[d, d], iconAnchor:[d/2, d/2]
          });
          return L.marker(latlng, { icon });
        },
        canvasBezierStyle:{
          type:'classBreaks', field:'e_Volume',
          classBreakInfos:[
            { classMinValue:1, classMaxValue:50000,   symbol:{ strokeStyle:getCSS('--line1','#ffb81c'), lineWidth:0.7, lineCap:'round', shadowColor:'#fee8c8', shadowBlur:2 } },
            { classMinValue:50000, classMaxValue:100000, symbol:{ strokeStyle:getCSS('--line2','#ff671f'), lineWidth:1.5, lineCap:'round', shadowColor:'#fdbb84', shadowBlur:2 } },
            { classMinValue:100000, classMaxValue:1600000, symbol:{ strokeStyle:getCSS('--line3','#d22630'), lineWidth:3.0, lineCap:'round', shadowColor:'#e34a33', shadowBlur:2 } }
          ],
          defaultSymbol:{ strokeStyle:'#d0d7e2', lineWidth:0.6, lineCap:'round', shadowColor:'#d0d7e2', shadowBlur:1.2 }
        },
        pathDisplayMode:'all',
        animationStarted:false,            // ← no animation
        animationEasingFamily:'Linear',
        animationEasingType:'None',
        animationDuration:0,
        onEachFeature:(feature, layer)=>attachInteractivity(feature, layer)
      }).addTo(map);

      // Hover/click focus
      let hoverLock = false;
      flowmapLayer.on('mouseover', (e) => {
        if (hoverLock) return;
        hoverLock = true; setTimeout(()=> hoverLock = false, 50);

        if (e.sharedDestinationFeatures?.length){
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          const l = e.layer;
          try{ l._icon?.classList?.add('focus'); setTimeout(()=>l._icon?.classList?.remove('focus'), 600);}catch{}
        }
        if (e.sharedOriginFeatures?.length){
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        }
      });

      flowmapLayer.on('click', (e) => {
        if (e.sharedDestinationFeatures?.length){
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
        } else if (e.sharedOriginFeatures?.length){
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        }
      });
    }

    function attachInteractivity(feature, layer){
      const name  = feature.properties?.e_locality || feature.properties?.s_State || 'Unknown';
      const total = feature.properties?.e_totalVolume ?? feature.properties?.s_totalVolume ?? 0;

      layer.bindTooltip(`${escapeHtml(name)}`, { direction:'top', offset:[0,-2] });

      layer.bindPopup(`
        <div style="min-width:220px">
          <h4 style="margin:0 0 8px;color:var(--brand-primary);font-weight:800">Location</h4>
          <p style="margin:0 0 6px"><strong>Name:</strong> ${escapeHtml(name)}</p>
          <p style="margin:0 0 6px"><strong>Total linked displaced:</strong> ${formatNumber(total)}</p>
          ${feature.properties?.main_needs ? `<p style="margin:0 0 6px"><strong>Main Needs:</strong> ${escapeHtml(String(feature.properties.main_needs))}</p>` : ''}
          <p style="margin:6px 0 0"><small>Click markers/lines to focus flows</small></p>
        </div>`);
    }

    /* === Crisis facts ring (subtle, static) ============================ */
    const AL_FASHER = [13.636, 25.349];
    function addCrisisFacts(){
      map.createPane('crisis'); map.getPane('crisis').style.zIndex = 480;
      crisisLayer = L.layerGroup([], { pane:'crisis' }).addTo(map);

      siegeRing = L.circle(AL_FASHER, {
        radius: 22000, color: '#d22630', weight: 2, dashArray: '6,6', dashOffset: '0',
        fillColor:'#d22630', fillOpacity:0.06
      }).bindTooltip('Reported siege area', {direction:'center', permanent:false, sticky:true}).addTo(crisisLayer);
    }

    /* Camps (optional) – kept if data exists */
    function addCampsLayer(){
      campsLayer = L.layerGroup([], { pane:'crisis' });
      Papa.parse('./data/camps.csv', {
        download:true, header:true, dynamicTyping:true, skipEmptyLines:true,
        complete: (res) => {
          const rows = (res.data || []).filter(r => Number.isFinite(parseFloat(r.lat)) && Number.isFinite(parseFloat(r.lon)));
          rows.forEach(r => {
            const status = String(r.status||'').toLowerCase().trim();
            const cls = status.includes('almost') && status.includes('empty') ? 'bad' : '';
            const icon = L.divIcon({
              className:'camp-pin',
              html:`<div class="camp-icon ${cls}"></div>`,
              iconSize:[18,18], iconAnchor:[9,9]
            });
            const occ = Number(r.occupancy)||null, cap = Number(r.capacity)||null;
            const occTxt = (occ && cap) ? `${occ.toLocaleString()} / ${cap.toLocaleString()}` : (occ ? occ.toLocaleString() : '—');

            L.marker([parseFloat(r.lat), parseFloat(r.lon)], { icon, pane:'crisis' })
              .bindTooltip(`${escapeHtml(r.name||'Camp')} · ${status || 'status unknown'}`, {direction:'top', offset:[0,-6]})
              .bindPopup(`
                <div class="kpi-card">
                  <div class="kpi" style="font-size:16px">${escapeHtml(r.name||'Camp')}</div>
                  <div class="label">Status: ${escapeHtml(status||'unknown')}</div>
                  <div class="label">Occupancy: ${occTxt}</div>
                </div>`)
              .addTo(campsLayer);
          });
          if (rows.length) campsLayer.addTo(map);
        },
        error:()=>{}
      });
    }

    // ─── Potential routes overlay (El Fasher → Tawila, At Tina) ────────
    function setupPotentialRoutes(){
      map.createPane('potential'); map.getPane('potential').style.zIndex = 475;

      const origin = { id:'ELFASHER', name:'El Fasher', lat:AL_FASHER[0], lon:AL_FASHER[1] };
      const dests = [
        { id:'SD02170', name:'Tawila',  lat:13.351266, lon:24.856704 },
        { id:'SD02171', name:'At Tina', lat:15.167895, lon:23.127019 }
      ];

      const fc = {
        type:'FeatureCollection',
        features: dests.map((d,i)=>({
          type:'Feature',
          geometry:{ type:'Point', coordinates:[origin.lon, origin.lat] },
          properties:{
            s_state_id: origin.id, s_State: origin.name, s_lat: origin.lat, s_lon: origin.lon,
            e_locality_id: d.id, e_locality: d.name, e_lat: d.lat, e_lon: d.lon,
            e_Volume: 100 + i*10
          }
        }))
      };

      routesLayer = L.canvasFlowmapLayer(fc, {
        pane:'potential',
        originAndDestinationFieldIds:{
          originUniqueIdField:'s_state_id',
          originGeometry:{ x:'s_lon', y:'s_lat' },
          destinationUniqueIdField:'e_locality_id',
          destinationGeometry:{ x:'e_lon', y:'e_lat' }
        },
        pointToLayer:()=> L.circleMarker([0,0],{radius:0.01,opacity:0,fillOpacity:0}),
        canvasBezierStyle:{
          type:'classBreaks', field:'e_Volume',
          classBreakInfos:[
            { classMinValue:1, classMaxValue:9999999, symbol:{ strokeStyle:getCSS('--potential','#0ea5e9'), lineWidth:3.2, lineCap:'round', shadowColor:'#7dd3fc', shadowBlur:3 } }
          ],
          defaultSymbol:{ strokeStyle:getCSS('--potential','#0ea5e9'), lineWidth:3.2, lineCap:'round', shadowColor:'#7dd3fc', shadowBlur:3 }
        },
        pathDisplayMode:'all',
        animationStarted:false,   // no animation
        animationDuration:0
      });

      routesMarkers = L.layerGroup([], { pane:'potential' });
      dests.forEach(d=>{
        const icon = L.divIcon({
          className:'dest-icon',
          html:`<div class="dot" style="--d:22px"></div>`,
          iconSize:[22,22], iconAnchor:[11,11]
        });
        L.marker([d.lat, d.lon], { icon, pane:'potential' })
          .bindTooltip(`${escapeHtml(d.name)} • ${d.id}`, {direction:'top', offset:[0,-8]})
          .addTo(routesMarkers);
      });

      routesOrigin = L.marker(AL_FASHER, {
        pane:'potential',
        icon: L.divIcon({ className:'origin-pulse-icon', html:'<div class="pulse" style="--d:28px"></div>', iconSize:[28,28], iconAnchor:[14,14] })
      }).bindTooltip('Origin: El Fasher', {direction:'top', offset:[0,-4]});

      routesGroup = L.featureGroup([routesLayer, routesMarkers, routesOrigin]);
    }

    function toggleRoutes(){
      routesVisible = !!chkRoutes.checked;
      if (!routesGroup){ setupPotentialRoutes(); }
      if (routesVisible){
        if (!map.hasLayer(routesGroup)) routesGroup.addTo(map);
        try{
          const b = L.latLngBounds([AL_FASHER]);
          routesMarkers?.eachLayer?.(m=> b.extend(m.getLatLng()));
          map.fitBounds(b.pad(0.2));
        }catch{}
      }else{
        if (map.hasLayer(routesGroup)) map.removeLayer(routesGroup);
      }
    }

    // ─── Helpers ---------------------------------------------------------
    function toGeoJSON(source){
      if (!source) return null;
      if (source.type === 'Topology' && window.topojson?.feature){
        const keys = Object.keys(source.objects || {});
        const key = keys.find(k => /admin.?1/i.test(k)) || keys[0];
        return key ? topojson.feature(source, source.objects[key]) : null;
      }
      return source;
    }
    function getCSS(varName, fallback){
      const v = getComputedStyle(document.documentElement).getPropertyValue(varName);
      return (v && v.trim()) ? v.trim() : fallback;
    }
    function getAdmin1Name(props = {}){
      return props.ADM1_EN || props.NAME_1 || props.admin1Name || props.state_name || props.State || props.NAME || props.ADM1_PCODE || null;
    }
    function getAdmin1Code(props = {}){
      const candidates = [props.ADM1_PCODE, props.STATE_CODE, props.code, props.STATECODE, props.state_code];
      const code = (candidates.find(x => x) || '').toString().trim();
      return code || null;
    }
    function safeCenter(layer){ try { return layer.getBounds().getCenter(); } catch { return null; } }
    function normalizeRow(r){
      return {
        s_state_id: String(r.s_state_id || r.origin_state_id || r.state_code || '').trim(),
        s_State: r.s_State || r.origin_state || r.state || 'Unknown',
        s_lat: parseFloat(r.s_lat), s_lon: parseFloat(r.s_lon),
        e_locality_id: String(r.e_locality_id || r.dest_locality_id || r.locality_code || '').trim(),
        e_locality: r.e_locality || r.dest_locality || r.locality || 'Unknown',
        e_lat: parseFloat(r.e_lat), e_lon: parseFloat(r.e_lon),
        e_Volume: parseFloat(r.e_Volume || r.volume || r.total || 0) || 0,
        main_needs: r.main_needs || r.needs || '',
        ...r
      };
    }
    function computeTotals(data){
      const destinationTotals = new Map();
      const originTotals = new Map();
      const destAggIndex = new Map();
      for (const d of data){
        destinationTotals.set(d.e_locality_id, (destinationTotals.get(d.e_locality_id) || 0) + d.e_Volume);
        originTotals.set(d.s_state_id, (originTotals.get(d.s_state_id) || 0) + d.e_Volume);
        if (!destAggIndex.has(d.e_locality_id)){
          destAggIndex.set(d.e_locality_id, { id:d.e_locality_id, name:d.e_locality||'Unknown', lat:d.e_lat, lon:d.e_lon, total:0 });
        }
        destAggIndex.get(d.e_locality_id).total += d.e_Volume;
      }
      const destAgg = [...destAggIndex.values()];
      return { destinationTotals, originTotals, destAgg };
    }
    function scaleRadiusLog(value, minV, maxV, rMin, rMax){
      const v = Math.max(minV || 1, Math.min(maxV || value || 1, value || 1));
      const a = Math.log(v) - Math.log(minV || 1);
      const b = Math.log(maxV || v) - Math.log(minV || 1);
      const t = b > 0 ? a / b : 0;
      return rMin + (rMax - rMin) * t;
    }
    function latlonKey(lat, lon){ return `${Number(lat).toFixed(4)},${Number(lon).toFixed(4)}`; }
    function formatNumber(x){ try { return Number(x).toLocaleString(undefined); } catch { return x; } }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }

  })();
  </script>
</body>
</html>
