<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Sudan | IDPs Pathways Across Sudan (Improved + Story)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --brand-primary:#2a5885;  /* IOM deep blue */
      --brand-accent:#418FDE;   /* IOM accent blue */
      --brand-amber:#ffb81c;    /* hover highlight */
      --surface:#f5f7fa;        /* app bg */
      --line1:#ffb81c; --line2:#ff671f; --line3:#d22630; /* flow colors */
    }

    html, body { height:100%; }
    body{
      margin:0; background:var(--surface); color:#1d2a36;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      display:flex; flex-direction:column; min-height:100vh;
    }

    /* ─── Header & Footer ─────────────────────────────────────────────── */
    .app-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 16px; background:#fff; border-bottom:1px solid #e6edf5;
      position:relative;
    }
    .app-header::after{
      content:""; position:absolute; left:0; right:0; bottom:-2px; height:2px;
      background:linear-gradient(90deg,var(--brand-primary),var(--brand-accent));
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand .logo{ width:36px; height:24px; border-radius:4px; overflow:hidden; display:block; box-shadow:0 0 0 1px #d1dbe7 inset; }
    .brand .logo svg{ width:100%; height:100%; display:block; }
    .brand h1{ font-size:16px; line-height:1.15; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brand .sub{ font-size:12px; color:#5a7086; font-weight:500; }

    .toolbar{ display:flex; align-items:center; flex-wrap:wrap; gap:6px; }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid #d1dbe7; background:#fff; color:#1d2a36;
      padding:6px 10px; border-radius:10px; font-size:12px; font-weight:600;
      cursor:pointer; user-select:none; transition:.2s ease;
    }
    .btn:hover{ border-color:#b7c6da; box-shadow:0 1px 0 rgba(0,0,0,.03); }
    .btn.active{ border-color:var(--brand-accent); background:#eef6ff; }

    .app-footer{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#fff; border-top:1px solid #e6edf5; padding:8px 12px; font-size:12px; color:#45607a;
    }
    .kbd{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; border:1px solid #c9d5e6; border-bottom-width:2px; padding:0 6px; border-radius:6px; background:#f7faff; }

    /* ─── Map container ───────────────────────────────────────────────── */
    .map-wrap{ position:relative; flex:1 1 auto; min-height:0; }
    #map{ position:absolute; inset:0; }

    .loading-overlay{
      position:absolute; inset:0; z-index:1100;
      background:rgba(255,255,255,.85);
      display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
    }
    .spinner{ width:44px; height:44px; border:4px solid #e7eef7; border-top-color:var(--brand-primary);
      border-radius:50%; animation:spin 1s linear infinite; margin-bottom:10px; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Admin1 labels */
    .leaflet-tooltip.state-label{
      background:transparent; border:none; box-shadow:none; padding:0;
      color:#244b6b; font-weight:600; font-size:12px; letter-spacing:.2px;
      text-shadow:0 0 2px #fff, 0 0 3px #fff, 0 0 4px #fff, 0 0 5px #fff;
      pointer-events:none;
    }

    /* ─── Pulsing origin points (UNCHANGED) ──────────────────────────── */
    .origin-pulse-icon{ pointer-events:auto; }
    .origin-pulse-icon .pulse{
      position:relative; width:var(--d,24px); height:var(--d,24px); border-radius:50%;
      background: radial-gradient(circle at 50% 45%,
        rgba(255,255,255,.95) 0 28%,
        rgba(255,103,31,1) 32%,
        rgba(255,103,31,.92) 60%,
        rgba(255,103,31,.85) 100%);
      box-shadow: 0 0 0 2px #ffffff inset, 0 2px 8px rgba(0,0,0,.18);
    }
    .origin-pulse-icon .pulse::before,
    .origin-pulse-icon .pulse::after{
      content:""; position:absolute; left:50%; top:50%;
      width:100%; height:100%; border-radius:50%;
      transform:translate(-50%,-50%) scale(.7);
      border:2px solid rgba(255,103,31,.7);
      animation:pulseRing 2.2s ease-out infinite;
    }
    .origin-pulse-icon .pulse::after{ animation-delay:1.1s; }
    @keyframes pulseRing { 0%{transform:translate(-50%,-50%) scale(.7);opacity:.9;} 70%{opacity:.2;} 100%{transform:translate(-50%,-50%) scale(2.1);opacity:0;} }

    /* ─── Destination points (IMPROVED) ──────────────────────────────── */
    .dest-icon{ pointer-events:auto; transition:transform .12s ease; }
    .dest-icon .dot{
      position:relative; width:var(--d,18px); height:var(--d,18px); border-radius:50%;
      background: radial-gradient(circle at 45% 30%,
        rgba(255,255,255,.95) 0 28%,
        rgba(65,143,222,1) 32%,
        rgba(65,143,222,.92) 60%,
        rgba(65,143,222,.85) 100%);
      border:1px solid #fff;
      box-shadow: 0 0 0 1px rgba(0,0,0,.06), 0 0 10px rgba(65,143,222,.35);
    }
    .dest-icon .dot::after{
      content:""; position:absolute; left:35%; top:28%; width:18%; height:18%;
      background:rgba(255,255,255,.9); border-radius:50%; filter:blur(.3px);
    }
    .dest-icon:hover{ transform:scale(1.1); }
    .dest-icon.focus{ transform:scale(1.18); box-shadow:0 0 0 2px rgba(65,143,222,.25); }

    /* Top destination labels (will be hidden by default) */
    .leaflet-tooltip.dest-label{
      background:#fff; color:#1d2a36; border:1px solid #d1dbe7;
      box-shadow:0 2px 8px rgba(0,0,0,.08); border-radius:8px; padding:4px 8px;
      font-size:12px; font-weight:600;
    }

    /* ─── Crisis facts UI ───────────────────────────────────────────── */
    .kpi-icon, .donut-icon, .note-icon { pointer-events:auto; }
    .kpi-card, .note-card{
      background:#fff; border:1px solid #d1dbe7; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:6px 10px; min-width:120px; text-align:left;
    }
    .kpi-card .kpi{ font-size:18px; font-weight:800; color:#1d2a36; line-height:1.1; }
    .kpi-card .label{ font-size:12px; color:#46607a; font-weight:600; margin-top:2px; }
    .note-card{ font-size:12px; color:#1d2a36; }
    .note-card strong{ color:#d22630; }

    .donut{
      width:44px; height:44px; border-radius:50%;
      background:conic-gradient(var(--donut-color,#418FDE) calc(var(--pct,0)*1deg), #e8eff7 0);
      border:2px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,.06), 0 0 10px rgba(65,143,222,.28);
      position:relative; display:inline-block; vertical-align:middle;
    }
    .donut::after{ content:""; position:absolute; inset:8px; background:#fff; border-radius:50%; box-shadow:inset 0 0 0 1px #e6eef6; }
    .donut-wrap{ display:flex; align-items:center; gap:8px; }
    .donut-wrap .txt .big{ font-weight:800; color:#1d2a36; }
    .donut-wrap .txt .small{ font-size:12px; color:#46607a; }

    .camp-icon{
      width:18px; height:18px; border-radius:50%; background:#999;
      border:1px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,.06);
      position:relative; opacity:.65;
    }
    .camp-icon::after{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:10px; height:10px; clip-path:polygon(50% 0, 100% 70%, 0 70%);
      background:#f4f4f4;
    }
    .camp-icon.bad{ background:#bbb; opacity:.45; }

    /* ─── Story / Slideshow panel ───────────────────────────────────── */
    .story-panel{
      position:absolute; right:14px; bottom:14px; z-index:1200;
      width:320px; max-width:85vw;
      background:#fff; border:1px solid #d1dbe7; border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.12); overflow:hidden; display:none;
    }
    .story-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:10px 12px; background:linear-gradient(0deg,#ffffff,#f8fbff);
      border-bottom:1px solid #eaf0f7;
    }
    .story-title{ font-weight:800; color:#1d2a36; font-size:14px; }
    .story-body{ padding:12px; color:#334a62; font-size:13px; line-height:1.35; }
    .story-footer{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px; border-top:1px solid #eaf0f7; background:#fff;
    }
    .story-dots{ display:flex; gap:6px; align-items:center; }
    .story-dot{ width:8px; height:8px; border-radius:50%; background:#dde6f2; }
    .story-dot.active{ background:var(--brand-accent); }
    .story-actions .btn{ padding:6px 8px; border-radius:8px; }

    @keyframes ping { 0%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,184,28,.0);} 50%{transform:scale(1.05);box-shadow:0 0 0 8px rgba(255,184,28,.25);} 100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,184,28,.0);} }
    .attention{ animation: ping 1.2s ease-out 3; }

    @media (max-width:768px){
      .brand h1{ font-size:14px; }
      .brand .sub{ display:none; }
      .btn span{ display:none; }
      .story-panel{ left:8px; right:8px; width:auto; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header" role="banner">
    <div class="brand" title="Sudan | IDPs Pathways Across Sudan">
      <!-- Sudan flag -->
      <div class="logo" role="img" aria-label="Sudan flag">
        <svg viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
          <rect width="3" height="2" fill="#000"/>
          <rect width="3" height="1.3333" y="0.3333" fill="#ffffff"/>
          <rect width="3" height="0.6667" fill="#D21034"/>
          <polygon points="0,0 0,2 1,1" fill="#007229"/>
        </svg>
      </div>
      <div>
        <h1>Sudan | Al Fasher Crisis</h1>
        <div class="sub">Flows between origin <strong>states</strong> and destination <strong>localities</strong></div>
      </div>
    </div>

    <nav class="toolbar" aria-label="Map controls">
      <button id="btn-play" class="btn active" title="Play/Pause animation (Space)"><i class="fa-solid fa-play"></i><span>Animation</span></button>
      <button id="btn-flows" class="btn active" title="Toggle flow lines (F)"><i class="fa-solid fa-wave-square"></i><span>Flows</span></button>
      <button id="btn-points" class="btn active" title="Toggle points (P)"><i class="fa-solid fa-circle"></i><span>Points</span></button>
      <button id="btn-story" class="btn" title="Open story / slideshow (S)"><i class="fa-solid fa-book-open"></i><span>Story</span></button>
      <button id="btn-reset" class="btn" title="Reset view (R)"><i class="fa-solid fa-rotate"></i><span>Reset</span></button>
    </nav>
  </header>

  <!-- Map -->
  <div class="map-wrap">
    <div id="map" aria-label="IDPs Pathways map of Sudan" role="region"></div>
    <div class="loading-overlay" id="loading-overlay" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <div>Loading displacement data…</div>
    </div>

    <!-- Story / Slideshow Panel -->
    <div class="story-panel" id="story-panel" role="dialog" aria-modal="false" aria-live="polite">
      <div class="story-header">
        <div class="story-title" id="story-title">Story</div>
        <div class="story-actions">
          <button id="story-prev" class="btn" title="Previous (←)"><i class="fa-solid fa-arrow-left"></i></button>
          <button id="story-toggle" class="btn" title="Play/Pause (Space)"><i class="fa-solid fa-play"></i></button>
          <button id="story-next" class="btn" title="Next (→)"><i class="fa-solid fa-arrow-right"></i></button>
          <button id="story-close" class="btn" title="Close (Esc)"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>
      <div class="story-body" id="story-body"></div>
      <div class="story-footer">
        <div class="story-dots" id="story-dots"></div>
        <div style="font-size:12px; color:#46607a;"><span id="story-count">1/5</span></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer" role="contentinfo">
    <div>
      <strong>Keyboard:</strong>
      <span class="kbd">Space</span> Play/Pause ·
      <span class="kbd">F</span> Flows ·
      <span class="kbd">P</span> Points ·
      <span class="kbd">S</span> Story ·
      <span class="kbd">R</span> Reset
    </div>
    <div>
      <span>© IOM DTM — Visualization prototype. Basemap © Mapbox/OSM.</span>
    </div>
  </footer>

  <!-- JS libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <!-- Local CanvasFlowmapLayer -->
  <script src="./src/CanvasFlowmapLayer.js"></script>

  <script>
  (function(){
    const MAPBOX_TOKEN = 'pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q';

    // Map init
    const map = L.map('map', {
      preferCanvas:true, zoomControl:false,
      minZoom:4, maxZoom:11, zoomSnap:0.5, zoomDelta:0.5, attributionControl:true
    }).setView([16,30], 5.5);

    // Basemaps (Mapbox Satellite default)
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap & CartoDB' });
    const mbLight   = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbStreets = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbSat     = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbOutdoor = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/outdoors-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbCustom  = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=' + MAPBOX_TOKEN, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    mbSat.addTo(map);

    const layerControl = L.control.layers({
      "Mapbox Custom": mbCustom,
      "Mapbox Light": mbLight,
      "Mapbox Streets": mbStreets,
      "Mapbox Outdoors": mbOutdoor,
      "Mapbox Satellite": mbSat,
      "Carto Light": cartoLight
    }).addTo(map);

    L.control.scale({ position:'bottomleft', metric:true, imperial:false }).addTo(map);
    L.control.zoom({ position:'bottomright' }).addTo(map);

    // ─── Legend ────────────────────────────────────────────────────────
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `
        <div style="background:#fff;border:1px solid #d1dbe7;border-radius:10px;padding:8px 10px;box-shadow:0 2px 10px rgba(0,0,0,.06);min-width:220px">
          <div style="font-weight:700;color:#1d2a36;margin-bottom:5px">Flow volume (e_Volume)</div>
          <div style="display:grid;grid-template-columns:18px 1fr;gap:8px;align-items:center;font-size:12px;color:#3c4f62;margin-bottom:6px">
            <span style="height:4px;background:var(--line1);"></span><span>1 — 50,000</span>
            <span style="height:4px;background:var(--line2);"></span><span>50,000 — 100,000</span>
            <span style="height:4px;background:var(--line3);"></span><span>100,000 — 1,600,000</span>
          </div>
          <div style="display:grid;grid-template-columns:18px 1fr;gap:8px;align-items:center;font-size:12px;color:#3c4f62">
            <span style="width:12px;height:12px;border-radius:50%;background:#ff671f;display:inline-block;box-shadow:0 0 0 2px #fff inset;"></span>
            <span>Origin state (pulsing by total)</span>
            <span style="width:12px;height:12px;border-radius:50%;background:var(--brand-accent);display:inline-block;border:1px solid #fff;box-shadow:0 0 8px rgba(65,143,222,.35)"></span>
            <span>Destination locality (glow by total)</span>
          </div>
        </div>`;
      return div;
    };
    legend.addTo(map);
    const legendEl = document.querySelector('.legend');
    if (legendEl){ L.DomEvent.disableScrollPropagation(legendEl); L.DomEvent.disableClickPropagation(legendEl); }

    // ─── State ────────────────────────────────────────────────────────
    let stateBoundariesLayer, admin1Labels, flowmapLayer, originPulseLayer, destLabelsLayer;
    let crisisLayer, campsLayer;
    let kpiMarker, donutMarker, noteMarker, siegeRing;
    let campsData = [];           // parsed camps
    let campsReady = Promise.resolve([]); // set later
    let isAnimationPlaying = true, showFlows = true, showPoints = true;

    // Toolbar buttons
    const btnPlay   = document.getElementById('btn-play');
    const btnFlows  = document.getElementById('btn-flows');
    const btnPoints = document.getElementById('btn-points');
    const btnReset  = document.getElementById('btn-reset');
    const btnStory  = document.getElementById('btn-story');

    btnPlay.addEventListener('click', toggleAnimation);
    btnFlows.addEventListener('click', toggleFlows);
    btnPoints.addEventListener('click', togglePoints);
    btnReset.addEventListener('click', ()=> map.setView([16,30], 5.5));
    btnStory.addEventListener('click', () => toggleStory(true));

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.target && e.target.closest && e.target.closest('input, textarea, [contenteditable="true"]')) return;
      const k = (e.key || '').toLowerCase();
      if (e.code === 'Space'){ e.preventDefault(); toggleAnimation(); }
      else if (k === 'f') toggleFlows();
      else if (k === 'p') togglePoints();
      else if (k === 's') toggleStory(true);
      else if (k === 'r') map.setView([16,30], 5.5);
    });

    function updateBtnStates(){
      btnPlay.classList.toggle('active', isAnimationPlaying);
      btnFlows.classList.toggle('active', showFlows);
      btnPoints.classList.toggle('active', showPoints);
      btnStory.classList.toggle('active', storyOpen);
    }
    function toggleAnimation(){
      isAnimationPlaying = !isAnimationPlaying;
      flowmapLayer?.setAnimationStarted?.(isAnimationPlaying);
      updateBtnStates();
    }
    function toggleFlows(){
      showFlows = !showFlows;
      flowmapLayer?.setPathDisplayMode?.(showFlows ? 'all' : 'none');
      updateBtnStates();
    }
    function togglePoints(){
      showPoints = !showPoints;
      flowmapLayer?.setPointVisibility?.(showPoints);
      // NOTE: Top destination labels are intentionally NOT auto-toggled here (kept hidden by default).
      if (originPulseLayer){
        if (showPoints && !map.hasLayer(originPulseLayer)) originPulseLayer.addTo(map);
        if (!showPoints && map.hasLayer(originPulseLayer)) map.removeLayer(originPulseLayer);
      }
      updateBtnStates();
    }

    // --- Load data
    const overlay = document.getElementById('loading-overlay');
    Promise.all([
      fetch('./data/ADMIN1.json').then(r => (r.ok ? r.json() : null)).catch(() => null),
      fetch('./data/sudan_states.geojson').then(r => (r.ok ? r.json() : null)).catch(() => null),
      new Promise((resolve, reject) => {
        Papa.parse('./data/IDPs_Pathway.csv', {
          download:true, header:true, dynamicTyping:true, skipEmptyLines:true,
          complete: res => resolve(res.data), error: reject
        });
      })
    ]).then(([admin1Maybe, fallbackStates, rows]) => {
      const states = toGeoJSON(admin1Maybe) || toGeoJSON(fallbackStates);
      if (states) addStyledAdmin1(states);

      const data = rows
        .map(r => normalizeRow(r))
        .filter(r =>
          Number.isFinite(r.s_lat) && Number.isFinite(r.s_lon) &&
          Number.isFinite(r.e_lat) && Number.isFinite(r.e_lon) &&
          Number.isFinite(r.e_Volume) && r.e_Volume > 0
        );

      const { destinationTotals, originTotals, destAgg } = computeTotals(data);
      data.forEach(d => {
        d.e_totalVolume = destinationTotals.get(d.e_locality_id) || d.e_Volume;
        d.s_totalVolume = originTotals.get(d.s_state_id) || d.e_Volume;
      });

      addOriginPulseLayer(data);         // UNCHANGED origin pulses
      initFlowmap(data);                 // improved destination markers
      addDestinationLabels(destAgg);     // created but HIDDEN by default

      overlay.style.display = 'none';

      // Crisis facts + optional Camps
      addCrisisFacts();
      // 👉 Open Story automatically on page load
      toggleStory(true);
      campsReady.then(()=>{/* ready for story */});
    }).catch(err => {
      overlay.innerHTML = '<div style="color:#b00020;text-align:center">Failed to load data. Check console.</div>';
      console.error(err);
    });

    // ---- Admin1 styled layer
    function addStyledAdmin1(states){
      map.createPane('admin1-casing');  map.getPane('admin1-casing').style.zIndex = 350;
      map.createPane('admin1-stroke');  map.getPane('admin1-stroke').style.zIndex = 351;
      map.createPane('admin1-labels');  map.getPane('admin1-labels').style.zIndex = 352;

      function strokeWeightForZoom(z){ return Math.max(0.8, Math.min(2.4, (z - 4) * 0.35)); }
      const admin1StrokeStyle = () => ({
        pane:'admin1-stroke',
        color: getCSS('--brand-primary','#2a5885'),
        weight: strokeWeightForZoom(map.getZoom()),
        opacity:0.95, fillColor:'#eaf2fb', fillOpacity:0.25,
        lineJoin:'round', lineCap:'round', smoothFactor:0.4, interactive:true
      });
      const admin1CasingStyle = () => ({
        pane:'admin1-casing',
        color:'#ffffff',
        weight: strokeWeightForZoom(map.getZoom()) + 2,
        opacity:0.9, fillOpacity:0,
        lineJoin:'round', lineCap:'round', smoothFactor:0.4, interactive:false
      });

      const admin1Casing = L.geoJSON(states, { style: admin1CasingStyle, interactive:false });
      const admin1Stroke = L.geoJSON(states, {
        style: admin1StrokeStyle,
        onEachFeature: (feat, lyr) => {
          const nm = getAdmin1Name(feat?.properties) || 'Admin 1';
          lyr.on({
            mouseover:e=>{
              e.target.setStyle({ color: getCSS('--brand-amber','#ffb81c'), weight: strokeWeightForZoom(map.getZoom()) + 1.2, fillOpacity:0.35 });
              e.target.bringToFront();
            },
            mouseout:()=>admin1Stroke.resetStyle(lyr),
            click:e=>{
              try { map.fitBounds(e.target.getBounds(), { padding:[20,20] }); } catch{}
              const code = getAdmin1Code(feat?.properties);
              if (code && flowmapLayer?.selectFeaturesForPathDisplayById){
                try { flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', String(code), true, 'SELECTION_NEW'); } catch {}
              }
            }
          });
          lyr.bindTooltip(nm, { sticky:true });
        }
      });

      admin1Labels = L.layerGroup([], { pane:'admin1-labels' });
      function rebuildLabels(){
        admin1Labels.clearLayers();
        if (map.getZoom() < 6) return;
        admin1Stroke.eachLayer(l => {
          const nm = getAdmin1Name(l.feature?.properties) || '';
          if (!nm) return;
          const c = safeCenter(l);
          if (!c) return;
          L.tooltip({ permanent:true, direction:'center', className:'state-label', pane:'admin1-labels' })
            .setContent(nm).setLatLng(c).addTo(admin1Labels);
        });
      }

      stateBoundariesLayer = L.featureGroup([admin1Casing, admin1Stroke]).addTo(map);
      stateBoundariesLayer.bringToBack();
      try { map.fitBounds(stateBoundariesLayer.getBounds(), { padding:[20,20] }); } catch {}

      rebuildLabels();
      admin1Labels.addTo(map);

      layerControl.addOverlay(stateBoundariesLayer, 'Admin 1 Boundaries');
      layerControl.addOverlay(admin1Labels, 'Admin 1 Labels');

      map.on('zoomend', ()=>{
        admin1Casing.setStyle(admin1CasingStyle());
        admin1Stroke.setStyle(admin1StrokeStyle());
        rebuildLabels();
      });
    }

    // ---- Origin pulsing layer (UNCHANGED)
    function addOriginPulseLayer(rows){
      map.createPane('origin-pulses');
      map.getPane('origin-pulses').style.zIndex = 460;

      const byState = new Map(); // s_state_id -> {lat,lon,name,total}
      for (const d of rows){
        if (!d.s_state_id) continue;
        if (!byState.has(d.s_state_id)){
          byState.set(d.s_state_id, { id:d.s_state_id, lat:d.s_lat, lon:d.s_lon, name:d.s_State||'Unknown', total:0 });
        }
        byState.get(d.s_state_id).total += Number(d.e_Volume)||0;
      }

      originPulseLayer = L.layerGroup([], { pane:'origin-pulses' });

      const totals = [...byState.values()].map(v => v.total);
      const tMin = Math.max(1, Math.min(...totals));
      const tMax = Math.max(...totals);
      const sizeFor = (v) => Math.round(scaleRadiusLog(v, tMin, tMax, 12, 28) * 2); // diameter

      byState.forEach((v) => {
        const size = sizeFor(v.total);
        const icon = L.divIcon({
          className: 'origin-pulse-icon',
          html: `<div class="pulse" style="--d:${size}px"></div>`,
          iconSize: [size, size],
          iconAnchor: [size/2, size/2]
        });

        const m = L.marker([v.lat, v.lon], { icon })
          .bindTooltip(`Displacement Origin: ${escapeHtml(v.name)}<br>Total displaced: ${formatNumber(v.total)}`, { direction:'top', offset:[0,-4] })
          .on('click', () => {
            try { flowmapLayer?.selectFeaturesForPathDisplayById?.('s_state_id', String(v.id), true, 'SELECTION_NEW'); } catch {}
          })
          .bindPopup(`
            <div style="min-width:220px">
              <h4 style="margin:0 0 8px;color:var(--brand-primary);font-weight:600">Displacement Origin</h4>
              <p style="margin:0 0 6px"><strong>State:</strong> ${escapeHtml(v.name)}</p>
              <p style="margin:0 0 0"><strong>Total Displaced:</strong> ${formatNumber(v.total)}</p>
            </div>`);

        originPulseLayer.addLayer(m);
      });

      originPulseLayer.addTo(map);
      layerControl.addOverlay(originPulseLayer, 'Origin points (pulsing)');
    }

    // ---- Destination labels overlay (Top N) — HIDDEN BY DEFAULT
    function addDestinationLabels(destAgg){
      map.createPane('dest-labels');
      map.getPane('dest-labels').style.zIndex = 470;
      destLabelsLayer = L.layerGroup([], { pane:'dest-labels' }); // NOTE: not added to map
      layerControl.addOverlay(destLabelsLayer, 'Top destination labels');

      function topNForZoom(z){ if (z<5) return 3; if (z<6) return 5; if (z<7) return 8; if (z<8) return 12; return 18; }
      function rebuild(){
        if (!destLabelsLayer) return;
        destLabelsLayer.clearLayers();
        const b = map.getBounds();
        const inView = destAgg.filter(d => b.contains([d.lat,d.lon]));
        inView.sort((a,b)=> b.total - a.total);
        const N = topNForZoom(map.getZoom());
        inView.slice(0, N).forEach(d => {
          const marker = L.marker([d.lat, d.lon], { interactive:true })
            .bindTooltip(`${escapeHtml(d.name)} • ${formatNumber(d.total)}`, {
              permanent:true, direction:'top', className:'dest-label', offset:[0,-8]
            })
            .on('click', () => {
              try { flowmapLayer?.selectFeaturesForPathDisplayById?.('e_locality_id', String(d.id), true, 'SELECTION_NEW'); } catch {}
            });
          destLabelsLayer.addLayer(marker);
        });
      }
      map.on('moveend zoomend', rebuild);
      rebuild();
    }

    // ---- Flowmap (improved destination markers)
    function initFlowmap(data){
      const originKeySet = new Set(data.map(d => latlonKey(d.s_lat, d.s_lon)));

      const fc = { type:'FeatureCollection', features: data.map(d => ({
        type:'Feature', geometry:{ type:'Point', coordinates:[d.s_lon, d.s_lat] }, properties:d
      })) };

      flowmapLayer = L.canvasFlowmapLayer(fc, {
        originAndDestinationFieldIds:{
          originUniqueIdField:'s_state_id',
          originGeometry:{ x:'s_lon', y:'s_lat' },
          destinationUniqueIdField:'e_locality_id',
          destinationGeometry:{ x:'e_lon', y:'e_lat' }
        },
        pointToLayer:(feature, latlng)=>{
          const isOriginSpot = originKeySet.has(latlonKey(latlng.lat, latlng.lng));
          if (isOriginSpot){
            return L.circleMarker(latlng, { radius:0.1, opacity:0, fillOpacity:0 });
          }
          const vol = feature.properties?.e_totalVolume || feature.properties?.e_Volume || 0;
          const d = Math.round(scaleRadiusLog(vol, 20000, 1600000, 10, 22)); // diameter
          const icon = L.divIcon({
            className:'dest-icon',
            html:`<div class="dot" style="--d:${d}px"></div>`,
            iconSize:[d, d],
            iconAnchor:[d/2, d/2]
          });
          return L.marker(latlng, { icon });
        },
        canvasBezierStyle:{
          type:'classBreaks',
          field:'e_Volume',
          classBreakInfos:[
            { classMinValue:1,       classMaxValue:50000,   symbol:{ strokeStyle:getCSS('--line1','#ffb81c'), lineWidth:0.7, lineCap:'round', shadowColor:'#fee8c8', shadowBlur:2 } },
            { classMinValue:50000,   classMaxValue:100000,  symbol:{ strokeStyle:getCSS('--line2','#ff671f'), lineWidth:1.5, lineCap:'round', shadowColor:'#fdbb84', shadowBlur:2 } },
            { classMinValue:100000,  classMaxValue:1600000, symbol:{ strokeStyle:getCSS('--line3','#d22630'), lineWidth:3.0, lineCap:'round', shadowColor:'#e34a33', shadowBlur:2 } }
          ],
          defaultSymbol:{ strokeStyle:'#d0d7e2', lineWidth:0.6, lineCap:'round', shadowColor:'#d0d7e2', shadowBlur:1.2 }
        },
        pathDisplayMode:'all',
        animationStarted:true,
        animationEasingFamily:'Linear',
        animationEasingType:'None',
        animationDuration:3200,
        onEachFeature:(feature, layer)=>attachInteractivity(feature, layer)
      }).addTo(map);

      // Hover/click focus
      let hoverLock = false;
      flowmapLayer.on('mouseover', (e) => {
        if (hoverLock) return; hoverLock = true; setTimeout(()=> hoverLock = false, 50);
        if (e.sharedDestinationFeatures?.length){
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          const l = e.layer;
          try{ l._icon?.classList?.add('focus'); setTimeout(()=>l._icon?.classList?.remove('focus'), 600);}catch{}
        }
        if (e.sharedOriginFeatures?.length){
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        }
      });
      flowmapLayer.on('click', (e) => {
        if (e.sharedDestinationFeatures?.length){
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
        } else if (e.sharedOriginFeatures?.length){
          flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        }
      });

      updateBtnStates();
      try { flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', 'SD02114', true, 'SELECTION_NEW'); } catch {}
    }

    function attachInteractivity(feature, layer){
      const name  = feature.properties?.e_locality || feature.properties?.s_State || 'Unknown';
      const total = feature.properties?.e_totalVolume ?? feature.properties?.s_totalVolume ?? 0;

      layer.bindTooltip(`${escapeHtml(name)}`, { direction:'top', offset:[0,-2] });
      layer.bindPopup(`
        <div style="min-width:220px">
          <h4 style="margin:0 0 8px;color:var(--brand-primary);font-weight:600">Location</h4>
          <p style="margin:0 0 6px"><strong>Name:</strong> ${escapeHtml(name)}</p>
          <p style="margin:0 0 6px"><strong>Total linked displaced:</strong> ${formatNumber(total)}</p>
          ${feature.properties?.main_needs ? `<p style="margin:0 0 6px"><strong>Main Needs:</strong> ${escapeHtml(String(feature.properties.main_needs))}</p>` : ''}
          <p style="margin:6px 0 0"><small>Click markers/lines to focus flows</small></p>
        </div>`);
    }

    /* === Crisis facts layer (Al Fasher) ================================== */
    const AL_FASHER = [13.636, 25.349];     // adjust if you have a more precise point
    const SIEGE_START = new Date('2024-05-01');
    const FACT_ATTACKS = 240;               // "More than 240 attacks"
    const FACT_DISPLACED_PCT = 0.80;        // "More than 80% displaced"
    const FACT_TRAPPED = 'Hundreds of thousands of civilians remain trapped';

    function monthsSince(date){
      const now = new Date();
      const y = now.getFullYear() - date.getFullYear();
      const m = now.getMonth() - date.getMonth();
      let months = y*12 + m;
      if (now.getDate() < date.getDate()) months -= 1;
      return Math.max(0, months);
    }

    function addCrisisFacts(){
      map.createPane('crisis'); map.getPane('crisis').style.zIndex = 480;
      crisisLayer = L.layerGroup([], { pane:'crisis' }).addTo(map);
      layerControl.addOverlay(crisisLayer, 'Crisis facts');

      // 1) Siege ring (dashed)
      siegeRing = L.circle(AL_FASHER, {
        radius: 22000,
        color: '#d22630', weight: 2, dashArray: '6,6', dashOffset: '0',
        fillColor:'#d22630', fillOpacity:0.08
      }).bindTooltip(
        `Under RSF siege since May 2024 · ~${monthsSince(SIEGE_START)} months`,
        { direction:'center', permanent:false, sticky:true }
      ).addTo(crisisLayer);

      // 2) KPI badge: 240+ attacks
      const attacksIcon = L.divIcon({
        className:'kpi-icon',
        html:`<div class="kpi-card" id="kpi-card">
                <div class="kpi">${FACT_ATTACKS.toLocaleString()}+</div>
                <div class="label">attacks</div>
              </div>`,
        iconSize:[1,1], iconAnchor:[0,0]
      });
      kpiMarker = L.marker([AL_FASHER[0]+0.045, AL_FASHER[1]-0.04], { icon: attacksIcon, pane:'crisis' })
        .addTo(crisisLayer);

      // 3) Donut: 80% displaced
      const deg = Math.round(FACT_DISPLACED_PCT*360);
      const donutIcon = L.divIcon({
        className:'donut-icon',
        html:`<div class="donut-wrap" id="donut-wrap">
                <div class="donut" style="--pct:${deg}"></div>
                <div class="txt">
                  <div class="big">${Math.round(FACT_DISPLACED_PCT*100)}%</div>
                  <div class="small">of population displaced</div>
                </div>
              </div>`,
        iconSize:[1,1], iconAnchor:[0,0]
      });
      donutMarker = L.marker([AL_FASHER[0]+0.02, AL_FASHER[1]+0.07], { icon: donutIcon, pane:'crisis' })
        .addTo(crisisLayer);

      // 4) Trapped note
      const noteIcon = L.divIcon({
        className:'note-icon',
        html:`<div class="note-card" id="note-card"><strong>Critical:</strong> ${FACT_TRAPPED}</div>`,
        iconSize:[1,1], iconAnchor:[0,0]
      });
      noteMarker = L.marker([AL_FASHER[0]-0.04, AL_FASHER[1]+0.02], { icon: noteIcon, pane:'crisis' })
        .addTo(crisisLayer);

      // 5) Optional: Camps
      campsReady = addCampsLayer();
    }

    /* Camps CSV:
       data/camps.csv
       name,lat,lon,status,occupancy,capacity
       Zamzam Camp,13.45,25.30,Almost empty,12000,220000
       Abu Shouk,13.70,25.32,Almost empty,8000,110000
       Al Salam,13.60,25.42,Almost empty,5000,90000
    */
    function addCampsLayer(){
      campsLayer = L.layerGroup([], { pane:'crisis' });
      layerControl.addOverlay(campsLayer, 'Camps (status)');
      return new Promise(resolve=>{
        if (!window.Papa){ resolve([]); return; }
        Papa.parse('./data/camps.csv', {
          download:true, header:true, dynamicTyping:true, skipEmptyLines:true,
          complete: (res) => {
            const rows = (res.data || []).filter(r => Number.isFinite(parseFloat(r.lat)) && Number.isFinite(parseFloat(r.lon)));
            campsData = rows.map(r => ({
              name: r.name || 'Camp',
              lat: parseFloat(r.lat),
              lon: parseFloat(r.lon),
              status: String(r.status||'').toLowerCase().trim(),
              occupancy: Number(r.occupancy)||null,
              capacity: Number(r.capacity)||null
            }));
            rows.forEach(r => {
              const status = String(r.status||'').toLowerCase().trim();
              const cls = status.includes('almost') && status.includes('empty') ? 'bad' : '';
              const icon = L.divIcon({
                className:'camp-pin',
                html:`<div class="camp-icon ${cls}"></div>`,
                iconSize:[18,18], iconAnchor:[9,9]
              });
              const occ = Number(r.occupancy)||null, cap = Number(r.capacity)||null;
              const occTxt = (occ && cap) ? `${occ.toLocaleString()} / ${cap.toLocaleString()}` : (occ ? occ.toLocaleString() : '—');
              L.marker([parseFloat(r.lat), parseFloat(r.lon)], { icon, pane:'crisis' })
                .bindTooltip(`${escapeHtml(r.name||'Camp')} · ${status || 'status unknown'}`, {direction:'top', offset:[0,-6]})
                .bindPopup(`
                  <div class="kpi-card">
                    <div class="kpi" style="font-size:16px">${escapeHtml(r.name||'Camp')}</div>
                    <div class="label">Status: ${escapeHtml(status||'unknown')}</div>
                    <div class="label">Occupancy: ${occTxt}</div>
                  </div>
                `)
                .addTo(campsLayer);
            });
            if (rows.length){ campsLayer.addTo(map); }
            resolve(campsData);
          },
          error:()=>{ resolve([]); }
        });
      });
    }

    // ─── Story / Slideshow logic ───────────────────────────────────────
    const storyPanel = document.getElementById('story-panel');
    const storyTitle = document.getElementById('story-title');
    const storyBody  = document.getElementById('story-body');
    const storyDots  = document.getElementById('story-dots');
    const storyCount = document.getElementById('story-count');
    const btnPrev = document.getElementById('story-prev');
    const btnNext = document.getElementById('story-next');
    const btnToggle = document.getElementById('story-toggle');
    const btnClose = document.getElementById('story-close');

    let storyOpen = false;
    let slideIdx = 0;
    let autoplay = true;
    let timer = null;
    let siegeAnimTimer = null;
    let campStep = 0;
    const SLIDE_MS = 6000;

    btnPrev.onclick = () => goToSlide(slideIdx-1, true);
    btnNext.onclick = () => goToSlide(slideIdx+1, true);
    btnToggle.onclick = () => toggleAutoplay();
    btnClose.onclick = () => toggleStory(false);

    window.addEventListener('keydown', (e)=>{
      if (!storyOpen) return;
      if (e.key === 'Escape') toggleStory(false);
      if (e.key === 'ArrowLeft') goToSlide(slideIdx-1, true);
      if (e.key === 'ArrowRight') goToSlide(slideIdx+1, true);
      if (e.code === 'Space'){ e.preventDefault(); toggleAutoplay(); }
    });
    window.addEventListener('blur', ()=> stopTimer());

    function toggleStory(open){
      storyOpen = open;
      storyPanel.style.display = open ? 'block' : 'none';
      btnStory.classList.toggle('active', open);
      updateBtnStates();
      if (open){
        buildDots();
        goToSlide(0, false);
      } else {
        stopTimer();
        cleanupSlide();
      }
    }
    function toggleAutoplay(){
      autoplay = !autoplay;
      btnToggle.innerHTML = autoplay ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
      if (autoplay){ scheduleNext(); } else { stopTimer(); }
    }
    function stopTimer(){ if (timer){ clearTimeout(timer); timer = null; } }
    function scheduleNext(){ stopTimer(); if (autoplay) timer = setTimeout(()=>goToSlide(slideIdx+1,false), SLIDE_MS); }

    function buildDots(){
      storyDots.innerHTML = '';
      const n = slides.length;
      for (let i=0;i<n;i++){
        const d = document.createElement('div');
        d.className = 'story-dot' + (i===slideIdx?' active':'');
        d.title = `Slide ${i+1}`;
        d.onclick = ()=> goToSlide(i, true);
        storyDots.appendChild(d);
      }
    }
    function setDotActive(){
      [...storyDots.children].forEach((c,i)=> c.classList.toggle('active', i===slideIdx));
      storyCount.textContent = `${slideIdx+1}/${slides.length}`;
    }

    function cleanupSlide(){
      document.getElementById('kpi-card')?.classList.remove('attention');
      document.getElementById('donut-wrap')?.classList.remove('attention');
      document.getElementById('note-card')?.classList.remove('attention');
      if (siegeAnimTimer){ clearInterval(siegeAnimTimer); siegeAnimTimer = null; }
      if (siegeRing){ siegeRing.setStyle({ dashOffset:'0', weight:2 }); }
    }

    function goToSlide(idx, userTriggered){
      cleanupSlide();
      if (idx < 0) idx = slides.length - 1;
      if (idx >= slides.length) idx = 0;
      slideIdx = idx;
      const s = slides[idx];
      storyTitle.textContent = s.title;
      storyBody.innerHTML = s.html;
      setDotActive();
      s.focus();
      if (userTriggered){ autoplay = false; btnToggle.innerHTML = '<i class="fa-solid fa-play"></i>'; }
      scheduleNext();
    }

    // Slides
    const slides = [
      {
        id:'siege',
        title:'Under RSF siege since May 2024',
        html:`<p>Al Fasher and its surroundings have been under siege since <strong>May 2024</strong>.</p>
              <p>A dashed red ring marks the siege area; tooltip shows how many months have elapsed.</p>`,
        focus: ()=> {
          if (!siegeRing) return;
          try { map.fitBounds(siegeRing.getBounds(), { padding:[30,30] }); } catch {}
          let off = 0, up = true;
          siegeAnimTimer = setInterval(()=>{
            off = (off + 2) % 24;
            siegeRing.setStyle({ dashOffset: String(off), weight: up ? 3 : 2 });
            up = !up;
          }, 350);
        }
      },
      {
        id:'attacks',
        title:'More than 240 attacks',
        html:`<p>A pinned KPI badge near the town center summarizes the intensity: <strong>240+ attacks</strong>.</p>`,
        focus: ()=> {
          if (!kpiMarker) return;
          const p = kpiMarker.getLatLng();
          map.setView(p, Math.max(map.getZoom(), 9), { animate:true });
          document.getElementById('kpi-card')?.classList.add('attention');
        }
      },
      {
        id:'displaced',
        title:'More than 80% displaced',
        html:`<p>A <strong>donut marker</strong> shows the share of population displaced — currently set to <strong>80%</strong>.</p>`,
        focus: ()=> {
          if (!donutMarker) return;
          const p = donutMarker.getLatLng();
          map.setView(p, Math.max(map.getZoom(), 9), { animate:true });
          document.getElementById('donut-wrap')?.classList.add('attention');
        }
      },
      {
        id:'trapped',
        title:'Hundreds of thousands trapped',
        html:`<p>An alert-style note highlights that <strong>hundreds of thousands</strong> of civilians remain <strong>trapped</strong>.</p>`,
        focus: ()=> {
          if (!noteMarker) return;
          const p = noteMarker.getLatLng();
          map.setView(p, Math.max(map.getZoom(), 9), { animate:true });
          document.getElementById('note-card')?.classList.add('attention');
        }
      },
      {
        id:'camps',
        title:'Three biggest camps almost empty',
        html:`<p>A mini tour focuses the <strong>three largest camps</strong> flagged <em>almost empty</em>. The map pans through them like a slideshow.</p>`,
        focus: ()=> tourCamps()
      }
    ];

    async function tourCamps(){
      const rows = await campsReady;
      if (!rows || !rows.length){
        storyBody.innerHTML += `<p style="margin-top:8px;color:#8a99ac">No <code>data/camps.csv</code> found or no rows. Add it to enable this slide.</p>`;
        return;
      }
      const almost = rows.filter(r => (r.status||'').includes('almost') && (r.status||'').includes('empty'));
      const base = (almost.length ? almost : rows).slice();
      base.sort((a,b)=> (b.capacity||0)-(a.capacity||0) || (b.occupancy||0)-(a.occupancy||0));
      const top3 = base.slice(0,3);
      let campStep = 0;
      const step = () => {
        if (!top3.length) return;
        const r = top3[campStep % top3.length];
        map.setView([r.lat, r.lon], 10, { animate:true });
        let best=null, bestD=1e9;
        campsLayer?.eachLayer(l=>{
          if (l.getLatLng){
            const d = map.distance(l.getLatLng(), L.latLng(r.lat, r.lon));
            if (d < bestD){ bestD = d; best = l; }
          }
        });
        try{
          const el = best?._icon || (best && best._container);
          el?.classList.add('attention');
          setTimeout(()=> el?.classList.remove('attention'), 1400);
          best?.openTooltip();
          setTimeout(()=> best?.closeTooltip(), 1800);
        }catch{}
        campStep++;
      };
      step();
      setTimeout(step, 2000);
      setTimeout(step, 4000);
    }

    // ─── Helpers
    function toGeoJSON(source){
      if (!source) return null;
      if (source.type === 'Topology' && window.topojson?.feature){
        const keys = Object.keys(source.objects || {});
        const key = keys.find(k => /admin.?1/i.test(k)) || keys[0];
        return key ? topojson.feature(source, source.objects[key]) : null;
      }
      return source; // assume GeoJSON
    }
    function getCSS(varName, fallback){
      const v = getComputedStyle(document.documentElement).getPropertyValue(varName);
      return (v && v.trim()) ? v.trim() : fallback;
    }
    function getAdmin1Name(props = {}){
      return props.ADM1_EN || props.NAME_1 || props.admin1Name || props.state_name || props.State || props.NAME || props.ADM1_PCODE || null;
    }
    function getAdmin1Code(props = {}){
      const candidates = [props.ADM1_PCODE, props.STATE_CODE, props.code, props.STATECODE, props.state_code];
      const code = (candidates.find(x => x) || '').toString().trim();
      return code || null;
    }
    function safeCenter(layer){ try { return layer.getBounds().getCenter(); } catch { return null; } }

    function normalizeRow(r){
      return {
        s_state_id: String(r.s_state_id || r.origin_state_id || r.state_code || '').trim(),
        s_State: r.s_State || r.origin_state || r.state || 'Unknown',
        s_lat: parseFloat(r.s_lat),
        s_lon: parseFloat(r.s_lon),
        e_locality_id: String(r.e_locality_id || r.dest_locality_id || r.locality_code || '').trim(),
        e_locality: r.e_locality || r.dest_locality || r.locality || 'Unknown',
        e_lat: parseFloat(r.e_lat),
        e_lon: parseFloat(r.e_lon),
        e_Volume: parseFloat(r.e_Volume || r.volume || r.total || 0) || 0,
        main_needs: r.main_needs || r.needs || '',
        ...r
      };
    }
    function computeTotals(data){
      const destinationTotals = new Map();
      const originTotals = new Map();
      const destAggIndex = new Map(); // id -> {id, name, lat, lon, total}

      for (const d of data){
        destinationTotals.set(d.e_locality_id, (destinationTotals.get(d.e_locality_id) || 0) + d.e_Volume);
        originTotals.set(d.s_state_id, (originTotals.get(d.s_state_id) || 0) + d.e_Volume);

        if (!destAggIndex.has(d.e_locality_id)){
          destAggIndex.set(d.e_locality_id, { id:d.e_locality_id, name:d.e_locality||'Unknown', lat:d.e_lat, lon:d.e_lon, total:0 });
        }
        destAggIndex.get(d.e_locality_id).total += d.e_Volume;
      }
      const destAgg = [...destAggIndex.values()];
      return { destinationTotals, originTotals, destAgg };
    }

    function scaleRadiusLog(value, minV, maxV, rMin, rMax){
      const v = Math.max(minV || 1, Math.min(maxV || value || 1, value || 1));
      const a = Math.log(v) - Math.log(minV || 1);
      const b = Math.log(maxV || v) - Math.log(minV || 1);
      const t = b > 0 ? a / b : 0;
      return rMin + (rMax - rMin) * t;
    }
    function latlonKey(lat, lon){ return `${Number(lat).toFixed(4)},${Number(lon).toFixed(4)}`; }
    function formatNumber(x){ try { return Number(x).toLocaleString(undefined); } catch { return x; } }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }

  })();
  </script>
</body>
</html>
