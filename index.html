<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Sudan | IDPs Pathways Across Sudan (Improved)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- Font Awesome (optional) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --brand-primary:#2a5885;  /* IOM deep blue */
      --brand-accent:#418FDE;   /* IOM accent blue */
      --brand-amber:#ffb81c;    /* hover highlight */
      --line1:#ffb81c; --line2:#ff671f; --line3:#d22630;
    }

    html, body { height:100%; }
    body{
      margin:0; background:#f5f7fa; color:#333;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      display:flex; flex-direction:column;
    }

    .map-container{ position:relative; flex:1 1 auto; }
    #map{ position:absolute; inset:0; }

    .loading-overlay{
      position:absolute; inset:0; z-index:1100;
      background:rgba(255,255,255,.85);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    .spinner{
      width:44px; height:44px; border:4px solid #e7eef7; border-top-color:var(--brand-primary);
      border-radius:50%; animation:spin 1s linear infinite; margin-bottom:12px;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .info-panel{
      position:absolute; left:12px; bottom:14px; z-index:1000;
      background:rgba(255,255,255,.95); padding:12px 14px; border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.15); max-width:min(320px,70vw); font-size:13px;
    }
    .info-panel h3{ margin:0 0 6px; color:var(--brand-primary); font-size:16px; }
    .info-panel p{ margin:0 0 8px; }
    .info-panel .close-btn{ position:absolute; top:6px; right:8px; border:none; background:transparent; font-size:18px; color:#666; cursor:pointer; }

    /* Admin1 labels */
    .leaflet-tooltip.state-label{
      background:transparent; border:none; box-shadow:none; padding:0;
      color:#244b6b; font-weight:600; font-size:12px; letter-spacing:.2px;
      text-shadow:0 0 2px #fff, 0 0 3px #fff, 0 0 4px #fff, 0 0 5px #fff; /* halo */
      pointer-events:none;
    }

    /* --- El Fasher emergency marker (pulsing) --- */
    .pulse-icon { position: relative; width: 20px; height: 20px; }
    .pulse-icon .dot{
      position:absolute; inset:5px; width:10px; height:10px; border-radius:50%;
      background:#d22630; border:2px solid #fff; box-shadow:0 0 0 rgba(210,38,48,.7);
      animation:pulse 2s infinite;
    }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(210,38,48,.5); }
      70%{ box-shadow:0 0 0 14px rgba(210,38,48,0); }
      100%{ box-shadow:0 0 0 0 rgba(210,38,48,0); }
    }

    @media (max-width:768px){ .info-panel{ font-size:12px; } }
  </style>
</head>
<body>
  <div class="map-container">
    <div id="map" aria-label="IDPs Pathways map of Sudan" role="region"></div>

    <div class="loading-overlay" id="loading-overlay" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <div>Loading displacement data…</div>
    </div>

    <div class="info-panel" id="info-panel">
      <button class="close-btn" id="close-info" aria-label="Close">&times;</button>
      <h3>How to use this map</h3>
      <p><strong>Click</strong> an origin state or destination point to focus flows.</p>
      <p><strong>Hover</strong> features for quick details.</p>
      <p>Shortcuts: <kbd>Space</kbd> play/pause, <kbd>F</kbd> flows, <kbd>P</kbd> points, <kbd>R</kbd> reset view, <kbd>E</kbd> El Fasher.</p>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Handle TopoJSON ADMIN1 -->
  <script src="https://unpkg.com/topojson-client@3"></script>
  <!-- Local CanvasFlowmapLayer -->
  <script src="./src/CanvasFlowmapLayer.js"></script>

  <script>
  (function(){
    const MAPBOX_TOKEN = 'pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q';

    // El Fasher (North Darfur) — siege context
    const EL_FASHER = { name:'El Fasher (North Darfur)', lat:13.6279, lon:25.3493, since:'May 2024' };

    // Map init
    const map = L.map('map', {
      preferCanvas:true, zoomControl:false,
      minZoom:4, maxZoom:11, zoomSnap:0.5, zoomDelta:0.5,
      attributionControl:true
    }).setView([16,30], 5.5);

    // Basemaps
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap & CartoDB' });
    const mbLight   = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbStreets = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbSat     = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbOutdoor = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/outdoors-v11/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    const mbCustom  = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=' + MAPBOX_TOKEN, { tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox & OpenStreetMap' });
    mbSat.addTo(map);   // Make Mapbox Satellite the default

    const layerControl = L.control.layers({
      "Mapbox Custom": mbCustom,
      "Mapbox Light": mbLight,
      "Mapbox Streets": mbStreets,
      "Mapbox Outdoors": mbOutdoor,
      "Mapbox Satellite": mbSat,
      "Carto Light": cartoLight
    }).addTo(map);

    L.control.scale({ position:'bottomleft', metric:true, imperial:false }).addTo(map);
    L.control.zoom({ position:'bottomright' }).addTo(map);

    let stateBoundariesLayer, admin1Labels, flowmapLayer;
    let isAnimationPlaying = true, showFlows = true, showPoints = true;

    // Info panel close
    document.getElementById('close-info').addEventListener('click', () => {
      document.getElementById('info-panel').style.display = 'none';
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      if (e.target && e.target.closest && e.target.closest('input, textarea, [contenteditable="true"]')) return;
      const k = (e.key || '').toLowerCase();
      if (e.code === 'Space'){ e.preventDefault(); toggleAnimation(); }
      else if (k === 'f') toggleFlows();
      else if (k === 'p') togglePoints();
      else if (k === 'r') map.setView([16,30], 5.5);
      else if (k === 'e') map.flyTo([EL_FASHER.lat, EL_FASHER.lon], 9, { duration:1.2 }); // jump to El Fasher
    });

    function toggleAnimation(){
      isAnimationPlaying = !isAnimationPlaying;
      if (flowmapLayer?.setAnimationStarted) flowmapLayer.setAnimationStarted(isAnimationPlaying);
    }
    function toggleFlows(){
      showFlows = !showFlows;
      if (flowmapLayer?.setPathDisplayMode) flowmapLayer.setPathDisplayMode(showFlows ? 'all' : 'none');
    }
    function togglePoints(){
      showPoints = !showPoints;
      if (flowmapLayer?.setPointVisibility) flowmapLayer.setPointVisibility(showPoints);
    }

    // --- Load data
    const overlay = document.getElementById('loading-overlay');
    Promise.all([
      fetch('./data/ADMIN1.json').then(r => (r.ok ? r.json() : null)).catch(() => null),
      fetch('./data/sudan_states.geojson').then(r => (r.ok ? r.json() : null)).catch(() => null),
      new Promise((resolve, reject) => {
        Papa.parse('./data/IDPs_Pathway.csv', {
          download:true, header:true, dynamicTyping:true, skipEmptyLines:true,
          complete: res => resolve(res.data), error: reject
        });
      })
    ]).then(([admin1Maybe, fallbackStates, rows]) => {
      const states = toGeoJSON(admin1Maybe) || toGeoJSON(fallbackStates);
      if (states) addStyledAdmin1(states);

      // Add El Fasher siege marker/overlay
      const elFasherLayer = addElFasherSiegeLayer();

      // Clean & process tabular rows
      const data = rows
        .map(r => normalizeRow(r))
        .filter(r =>
          Number.isFinite(r.s_lat) && Number.isFinite(r.s_lon) &&
          Number.isFinite(r.e_lat) && Number.isFinite(r.e_lon) &&
          Number.isFinite(r.e_Volume) && r.e_Volume > 0
        );

      const { destinationTotals, originTotals } = computeTotals(data);
      data.forEach(d => {
        d.e_totalVolume = destinationTotals.get(d.e_locality_id) || d.e_Volume;
        d.s_totalVolume = originTotals.get(d.s_state_id) || d.e_Volume;
      });

      initFlowmap(data);
      overlay.style.display = 'none';
    }).catch(err => {
      overlay.innerHTML = '<div style="color:#b00020;text-align:center">Failed to load data. Check console.</div>';
      console.error(err);
    });

    // ---- Admin1 styled layer (casing + stroke + labels)
    function addStyledAdmin1(states){
      // Panes for drawing order
      map.createPane('admin1-casing');  map.getPane('admin1-casing').style.zIndex = 350;
      map.createPane('admin1-stroke');  map.getPane('admin1-stroke').style.zIndex = 351;
      map.createPane('admin1-labels');  map.getPane('admin1-labels').style.zIndex = 352;

      function strokeWeightForZoom(z){
        return Math.max(0.8, Math.min(2.4, (z - 4) * 0.35)); // 0.8..2.4
      }
      const admin1StrokeStyle = () => ({
        pane:'admin1-stroke',
        color: getComputedStyle(document.documentElement).getPropertyValue('--brand-primary') || '#2a5885',
        weight: strokeWeightForZoom(map.getZoom()),
        opacity:0.95,
        fillColor:'#eaf2fb',
        fillOpacity:0.25,
        lineJoin:'round', lineCap:'round',
        smoothFactor:0.4, interactive:true
      });
      const admin1CasingStyle = () => ({
        pane:'admin1-casing',
        color:'#ffffff',
        weight: strokeWeightForZoom(map.getZoom()) + 2,
        opacity:0.9,
        fillOpacity:0,
        lineJoin:'round', lineCap:'round',
        smoothFactor:0.4, interactive:false
      });

      const admin1Casing = L.geoJSON(states, { style: admin1CasingStyle, interactive:false });
      const admin1Stroke = L.geoJSON(states, {
        style: admin1StrokeStyle,
        onEachFeature: (feat, lyr) => {
          const nm = getAdmin1Name(feat?.properties) || 'Admin 1';
          lyr.on({
            mouseover:e=>{
              e.target.setStyle({ color: getCSS('--brand-amber','#ffb81c'), weight: strokeWeightForZoom(map.getZoom()) + 1.2, fillOpacity:0.35 });
              e.target.bringToFront();
            },
            mouseout:()=>admin1Stroke.resetStyle(lyr),
            click:e=>{
              try { map.fitBounds(e.target.getBounds(), { padding:[20,20] }); } catch{}
              // Optional: filter flows by state code if we can detect it
              const code = getAdmin1Code(feat?.properties);
              if (code && flowmapLayer?.selectFeaturesForPathDisplayById){
                try { flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', String(code), true, 'SELECTION_NEW'); } catch {}
              }
            }
          });
          lyr.bindTooltip(nm, { sticky:true });
        }
      });

      // Labels: only when zoomed in
      admin1Labels = L.layerGroup([], { pane:'admin1-labels' });
      function rebuildLabels(){
        admin1Labels.clearLayers();
        if (map.getZoom() < 6) return;
        admin1Stroke.eachLayer(l => {
          const nm = getAdmin1Name(l.feature?.properties) || '';
          if (!nm) return;
          const c = safeCenter(l);
          if (!c) return;
          L.tooltip({
            permanent:true, direction:'center', className:'state-label', pane:'admin1-labels'
          }).setContent(nm).setLatLng(c).addTo(admin1Labels);
        });
      }

      stateBoundariesLayer = L.featureGroup([admin1Casing, admin1Stroke]).addTo(map);
      stateBoundariesLayer.bringToBack();
      try { map.fitBounds(stateBoundariesLayer.getBounds(), { padding:[20,20] }); } catch {}

      rebuildLabels();
      admin1Labels.addTo(map);

      layerControl.addOverlay(stateBoundariesLayer, 'Admin 1 Boundaries');
      layerControl.addOverlay(admin1Labels, 'Admin 1 Labels');

      map.on('zoomend', ()=>{
        admin1Casing.setStyle(admin1CasingStyle());
        admin1Stroke.setStyle(admin1StrokeStyle());
        rebuildLabels();
      });
    }

    // ---- El Fasher marker layer
    function addElFasherSiegeLayer(){
      const layer = L.layerGroup();
      // dashed alert ring
      L.circle([EL_FASHER.lat, EL_FASHER.lon], {
        radius: 12000, color:'#d22630', weight:2, dashArray:'6 6',
        fillColor:'#d22630', fillOpacity:0.12
      }).addTo(layer);

      // pulsing pin
      const icon = L.divIcon({ className:'pulse-icon', html:'<span class="dot" title="El Fasher"></span>', iconSize:[20,20] });
      const m = L.marker([EL_FASHER.lat, EL_FASHER.lon], { icon }).addTo(layer);

      m.bindTooltip(`${EL_FASHER.name} — siege since ${EL_FASHER.since}`, { direction:'top', offset:[0,-10], sticky:true });

      m.bindPopup(`
        <div style="min-width:260px">
          <h4 style="margin:0 0 6px;color:var(--brand-primary)">El Fasher (North Darfur)</h4>
          <p style="margin:0 0 6px"><strong>Status:</strong> Under RSF siege since <strong>${EL_FASHER.since}</strong>.</p>
          <p style="margin:0 0 6px"><strong>Context:</strong> Ongoing shelling and severe civilian impact reported by UN/OHCHR and international coverage.</p>
          <p style="margin:6px 0 0"><small>Press <kbd>E</kbd> to fly here.</small></p>
        </div>
      `);

      layer.addTo(map);
      layerControl.addOverlay(layer, 'El Fasher Siege (May 2024–present)');
      return layer;
    }

    // ---- Flowmap
    function initFlowmap(data){
      const fc = { type:'FeatureCollection', features: data.map(d => ({
        type:'Feature', geometry:{ type:'Point', coordinates:[d.s_lon, d.s_lat] }, properties:d
      })) };

      flowmapLayer = L.canvasFlowmapLayer(fc, {
        originAndDestinationFieldIds:{
          originUniqueIdField:'s_state_id',
          originGeometry:{ x:'s_lon', y:'s_lat' },
          destinationUniqueIdField:'e_locality_id',
          destinationGeometry:{ x:'e_lon', y:'e_lat' }
        },
        pointToLayer:(feature, latlng)=>{
          const isOrigin = feature.properties && feature.properties.isOrigin;
          const vol = isOrigin ? (feature.properties.s_totalVolume || 0) : (feature.properties.e_totalVolume || 0);
          const r = isOrigin ? scaleRadius(vol, 20000, 6, 12) : scaleRadius(vol, 20000, 5, 10);
          const color = isOrigin ? '#ff671f' : getCSS('--brand-accent', '#418FDE');
          return L.circleMarker(latlng, {
            radius:r, weight:1, color:'#fff',
            fillColor:color, fillOpacity: isOrigin ? 0.85 : 0.75, opacity:1
          });
        },
        canvasBezierStyle:{
          type:'classBreaks',
          field:'e_Volume',
          classBreakInfos:[
            { classMinValue:1,       classMaxValue:50000,   symbol:{ strokeStyle:getCSS('--line1','#ffb81c'), lineWidth:0.7, lineCap:'round', shadowColor:'#fee8c8', shadowBlur:2 } },
            { classMinValue:50000,   classMaxValue:100000,  symbol:{ strokeStyle:getCSS('--line2','#ff671f'), lineWidth:1.5, lineCap:'round', shadowColor:'#fdbb84', shadowBlur:2 } },
            { classMinValue:100000,  classMaxValue:1600000, symbol:{ strokeStyle:getCSS('--line3','#d22630'), lineWidth:3.0, lineCap:'round', shadowColor:'#e34a33', shadowBlur:2 } }
          ],
          defaultSymbol:{ strokeStyle:'#d0d7e2', lineWidth:0.6, lineCap:'round', shadowColor:'#d0d7e2', shadowBlur:1.2 }
        },
        pathDisplayMode:'all',
        animationStarted:true,
        animationEasingFamily:'Linear',
        animationEasingType:'None',
        animationDuration:3200,
        onEachFeature:(feature, layer)=>attachInteractivity(feature, layer)
      }).addTo(map);

      // Hover & click focus on flow features
      let hoverLock = false;
      flowmapLayer.on('mouseover', (e) => {
        if (hoverLock) return; hoverLock = true; setTimeout(()=> hoverLock = false, 50);
        if (e.sharedOriginFeatures?.length) flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        if (e.sharedDestinationFeatures?.length) flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
      });
      flowmapLayer.on('click', (e) => {
        if (e.sharedOriginFeatures?.length) flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
        else if (e.sharedDestinationFeatures?.length) flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
      });

      // Optional initial selection (safe no-op)
      try { flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', 'SD02114', true, 'SELECTION_NEW'); } catch {}
    }

    function attachInteractivity(feature, layer){
      const isOrigin = feature.properties && feature.properties.isOrigin;
      const title = isOrigin ? 'Displacement Origin' : 'Displacement Destination';
      const name  = isOrigin ? (feature.properties.s_State || 'Unknown') : (feature.properties.e_locality || 'Unknown');
      const total = isOrigin ? (feature.properties.s_totalVolume || 0) : (feature.properties.e_totalVolume || 0);

      layer.bindTooltip(`${title}: ${escapeHtml(name)}`, { direction:'top', offset:[0,-2] });
      const popup = `
        <div style="min-width:220px">
          <h4 style="margin:0 0 8px;color:var(--brand-primary);font-weight:600">${title}</h4>
          <p style="margin:0 0 6px"><strong>${isOrigin ? 'State' : 'Location'}:</strong> ${escapeHtml(name)}</p>
          <p style="margin:0 0 6px"><strong>Total Displaced:</strong> ${formatNumber(total)}</p>
          ${feature.properties.main_needs ? `<p style="margin:0 0 6px"><strong>Main Needs:</strong> ${escapeHtml(String(feature.properties.main_needs))}</p>` : ''}
          <p style="margin:6px 0 0"><small>Click markers/lines to focus flows</small></p>
        </div>`;
      layer.bindPopup(popup);
    }

    // ---- Helpers
    function toGeoJSON(source){
      if (!source) return null;
      if (source.type === 'Topology' && window.topojson?.feature){
        const keys = Object.keys(source.objects || {});
        const key = keys.find(k => /admin.?1/i.test(k)) || keys[0];
        return key ? topojson.feature(source, source.objects[key]) : null;
      }
      return source; // assume GeoJSON
    }
    function getCSS(varName, fallback){
      const v = getComputedStyle(document.documentElement).getPropertyValue(varName);
      return v && v.trim() ? v.trim() : fallback;
    }
    function getAdmin1Name(props = {}){
      return props.ADM1_EN || props.NAME_1 || props.admin1Name || props.state_name || props.State || props.NAME || props.ADM1_PCODE || null;
    }
    // Try to map Admin1 feature -> s_state_id code (e.g., "SD15")
    function getAdmin1Code(props = {}){
      // common property names from humanitarian admin datasets
      const candidates = [props.ADM1_PCODE, props.STATE_CODE, props.code, props.STATECODE, props.state_code];
      const code = (candidates.find(x => x) || '').toString().trim();
      // If not provided, try to infer from name via lookup table (customize if needed)
      return code || null;
    }
    function safeCenter(layer){
      try { return layer.getBounds().getCenter(); } catch { return null; }
    }

    function normalizeRow(r){
      return {
        // origins
        s_state_id: String(r.s_state_id || r.origin_state_id || r.state_code || '').trim(),
        s_State: r.s_State || r.origin_state || r.state || 'Unknown',
        s_lat: parseFloat(r.s_lat),
        s_lon: parseFloat(r.s_lon),
        // destinations
        e_locality_id: String(r.e_locality_id || r.dest_locality_id || r.locality_code || '').trim(),
        e_locality: r.e_locality || r.dest_locality || r.locality || 'Unknown',
        e_lat: parseFloat(r.e_lat),
        e_lon: parseFloat(r.e_lon),
        // metrics
        e_Volume: parseFloat(r.e_Volume || r.volume || r.total || 0) || 0,
        main_needs: r.main_needs || r.needs || '',
        ...r
      };
    }
    function computeTotals(data){
      const destinationTotals = new Map();
      const originTotals = new Map();
      for (const d of data){
        destinationTotals.set(d.e_locality_id, (destinationTotals.get(d.e_locality_id) || 0) + d.e_Volume);
        originTotals.set(d.s_state_id, (originTotals.get(d.s_state_id) || 0) + d.e_Volume);
      }
      return { destinationTotals, originTotals };
    }

    function scaleRadius(value, step, rMin, rMax){
      if (!Number.isFinite(value) || value <= 0) return rMin;
      const v = Math.log(1 + value / Math.max(step, 1));
      const t = Math.min(v / Math.log(1 + 20), 1);
      return rMin + (rMax - rMin) * t;
    }
    function formatNumber(x){ try { return Number(x).toLocaleString(undefined); } catch { return x; } }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',''': '&#39;'}[s])); }
  })();
  </script>
</body>
</html>
